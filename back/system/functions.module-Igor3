<?php
	class MySystem
	{
		private $cnst_svr = 'mysql2.camaltec-services.com';
		private $cnst_usr = 'tiendaDemo';
		private $cnst_pwd = 'TUwYVtYU39b3ADSQ';
		private $cnst_dbn = 'tiendaDemo_db';

		private $cnst_prt = '3306';
		private $conexion = null;
		private $usuario = null;
		private $empresa = null;
		private $prefijo = '@CamaltecFiltros!';
		private $sufijo = '?Cierre</>@';	
                
                private $no_permitidas= array ("'","/","!","¡","?","¿","\"","$","%","&","(",")","=","[","]","{","}","+","*",",",";",":","·",">","<","á","é","í","ó","ú","Á","É","Í","Ó","Ú","ñ","À","Ã","Ì","Ò","Ù","Ã™","Ã ","Ã¨","Ã¬","Ã²","Ã¹","ç","Ç","Ã¢","ê","Ã®","Ã´","Ã»","Ã‚","ÃŠ","ÃŽ","Ã”","Ã›","ü","Ã¶","Ã–","Ã¯","Ã¤","«","Ò","Ã","Ã„","Ã‹", " ");
                private $permitidas= array ("","","","","","","","","","","","","","","","","","","","","","","","","","a","e","i","o","u","A","E","I","O","U","n","N","A","E","I","O","U","a","e","i","o","u","c","C","a","e","i","o","u","A","E","I","O","U","u","o","O","i","a","e","U","I","A","E","-");

		
		function ControlDeSesiones()
		{
			if (@$_SESSION['usr'] != null)
                if(@$_SESSION['usr']['rol'] == 1)
				    $this->usuario = $_SESSION['usr'];
			if (@$_SESSION['empresa'] != null)
				$this->empresa = $_SESSION['empresa'];
            
			if (($this->usuario == null || $this->usuario['rol'] > 2) && basename($_SERVER['PHP_SELF']) != 'login.php')
				header('Location: login.php');
			else if (($this->usuario != null && $this->usuario['rol'] < 3) && basename($_SERVER['PHP_SELF']) == 'login.php')
				header('Location: index.php');
		}
		
		function Conectar()
		{
			$this->conexion = mysqli_connect($this->cnst_svr, $this->cnst_usr, $this->cnst_pwd, $this->cnst_dbn, $this->cnst_prt);
			mysqli_set_charset($this->conexion, 'UTF8');
		}
		
		function Desconectar()
		{
			mysqli_close($this->conexion);
			$this->conexion = null;
		}
		
		function ExisteUsuario()
		{
			if ($this->usuario != null)
				return true;
			else
				return false;
		}
		
		function Usuario($clave)
		{
			if (@$this->usuario[$clave] != null)
				return $this->usuario[$clave];
			else
				return null;
		}
		
		function filtropass($pass)
		{
			return sha1(md5($this->prefijo.$pass.$this->sufijo));
		}
		
		function setUsuario($array)
		{
			$_SESSION['usr'] = $array;
			$this->usuario = $array;
		}
		
		function unsetUsuario()
		{
			$_SESSION['usr'] = null;
			$this->usuario = null;
		}
		
		function setEmpresa($array)
		{
			$_SESSION['empresa'] = $array;
			$this->empresa = $array;
		}
		
		function unsetEmpresa()
		{
			$_SESSION['empresa'] = null;
			$this->empresa = null;
		}
		
		function Entrar($usuario, $pass)
		{
			$usuario = mysqli_real_escape_string($this->conexion, htmlspecialchars($usuario));
			$pass = mysqli_real_escape_string($this->conexion, $this->filtropass(htmlspecialchars($pass)));
			
			$sql = "SELECT id, nombre, email, sesion, rol
					FROM bd_users
					WHERE email = '$usuario'
					AND pass = '$pass' AND rol = 1;";
			$query = mysqli_query($this->conexion, $sql);
                        
			if (mysqli_num_rows($query) == 1)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$this->setUsuario($assoc);
				header('Location: login.php');
			}
		}
		
		function Salir()
		{
			$this->unsetUsuario();
			header('Location: login.php');
		}
		
		function UsuarioEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_users
					SET estado = IF(estado = 'A', 'S', 'A')
					WHERE id = '$id'";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function UsuarioEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_users
					WHERE id = $id
					AND rol <> 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
                function CargarConfIdiomas()
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_idiomas
                                        WHERE iniciales <> 'ESP'
					ORDER BY id ASC";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarConfDivisas()
		{
			$resultados = array();
			
			$sql = "SELECT Codigo
					FROM bd_divisa
                                        WHERE Activa = 1
                                        ORDER BY Codigo ASC";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['Codigo']] = '1';

			return $resultados;
		}
		
		function ProductoEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_productos
					SET disponible = ABS(disponible - 1)
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function ProductoVisualizado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_productos
					SET soloR = ABS(soloR - 1)
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ProductoDestacado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_productos
					SET destacado = ABS(destacado - 1)
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function CargarAtributosProds()
		{
			$resultados = array();
			
			$sql = "SELECT bd_atributo.id as ida, bd_atributo.atributo as atributo, bd_atributo.tipoid, bd_atributo_tipo.atributo as nombre FROM bd_atributo, bd_atributo_tipo WHERE bd_atributo.tipoid = bd_atributo_tipo.id ORDER BY bd_atributo.tipoid, ida;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function ProductoEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_productos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PackEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_pack
					SET eliminado = 1
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ProductoRelacionadoCrear($id, $id2)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$id2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($id2));
			 
			$sql = "INSERT INTO bd_productos_relacionados
					VALUES (null, $id, $id2);";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ProductoNuevoAtr($atr,$precio, $url){
            $sql = "INSERT INTO bd_producto_atributo
					VALUES (null, $atr, 0, $precio, '$url');";
			$query = mysqli_query($this->conexion, $sql);
        }
        
        function IdiomasModificar($ingles, $aleman, $frances, $italiano, $portugues, $catalan, $ruso)
		{
			$ingles = mysqli_real_escape_string($this->conexion, htmlspecialchars($ingles));
            $aleman = mysqli_real_escape_string($this->conexion, htmlspecialchars($aleman));
            $frances = mysqli_real_escape_string($this->conexion, htmlspecialchars($frances));
            $italiano = mysqli_real_escape_string($this->conexion, htmlspecialchars($italiano));
            $portugues = mysqli_real_escape_string($this->conexion, htmlspecialchars($portugues));
            $catalan = mysqli_real_escape_string($this->conexion, htmlspecialchars($catalan));
            $ruso = mysqli_real_escape_string($this->conexion, htmlspecialchars($ruso));
            
            $sql = "UPDATE bd_idiomas
                SET activo = $ingles
                WHERE id = 2;";
                
            $query = mysqli_query($this->conexion, $sql);
                    
            $sql = "UPDATE bd_idiomas
                SET activo = $aleman
                WHERE id = 3;";
                
            $query = mysqli_query($this->conexion, $sql);
                    
            $sql = "UPDATE bd_idiomas
                SET activo = $frances
                WHERE id = 4;";
                
            $query = mysqli_query($this->conexion, $sql);

            $sql = "UPDATE bd_idiomas
                SET activo = $italiano
                WHERE id = 5;";
                
            $query = mysqli_query($this->conexion, $sql);

            $sql = "UPDATE bd_idiomas
                SET activo = $portugues
                WHERE id = 6;";
                
            $query = mysqli_query($this->conexion, $sql);
            
            $sql = "UPDATE bd_idiomas
                SET activo = $catalan
                WHERE id = 7;";
                
            $query = mysqli_query($this->conexion, $sql);

            $sql = "UPDATE bd_idiomas
                SET activo = $ruso
                WHERE id = 8;";
                
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function DivisasModificar($euro, $libra, $yen, $usd, $fsuizo)
	{
            $euro = mysqli_real_escape_string($this->conexion, htmlspecialchars($euro));
            $libra = mysqli_real_escape_string($this->conexion, htmlspecialchars($libra));
            $yen = mysqli_real_escape_string($this->conexion, htmlspecialchars($yen));
            $usd = mysqli_real_escape_string($this->conexion, htmlspecialchars($usd));
            $fsuizo = mysqli_real_escape_string($this->conexion, htmlspecialchars($fsuizo));
            
            $sql = "UPDATE bd_divisa
                SET Activa = $euro
                WHERE Codigo = 'EUR';";
                
            $query = mysqli_query($this->conexion, $sql);
                    
            $sql = "UPDATE bd_divisa
                SET Activa = $libra
                WHERE Codigo = 'GBP';";
                
            $query = mysqli_query($this->conexion, $sql);
                    
            $sql = "UPDATE bd_divisa
                SET Activa = $yen
                WHERE Codigo = 'JPY';";
                
            $query = mysqli_query($this->conexion, $sql);

            $sql = "UPDATE bd_divisa
                SET Activa = $usd
                WHERE Codigo = 'USD';";
                
            $query = mysqli_query($this->conexion, $sql);
            
            $sql = "UPDATE bd_divisa
                SET Activa = $fsuizo
                WHERE Codigo = 'CHF';";
                
            $query = mysqli_query($this->conexion, $sql);

            return $query;  
        }
		
		function ProductoAtributoCrear($idp, $ida)
		{
			$idp = mysqli_real_escape_string($this->conexion, htmlspecialchars($idp));
			$ida = mysqli_real_escape_string($this->conexion, htmlspecialchars($ida));
			
			$sql = "INSERT INTO bd_producto_atributo
					VALUES (null, $ida, $idp);";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ProductoRelacionadoEliminar($id, $id2)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$id2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($id2));
			
			$sql = "DELETE FROM bd_productos_relacionados
					WHERE idproducto1 = $id
					AND idproducto2 = $id2;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ProductoAtributoEliminar($idrel)
		{
			$idrel = mysqli_real_escape_string($this->conexion, htmlspecialchars($idrel));
			
			$sql = "DELETE FROM bd_producto_atributo
					WHERE id = $idrel;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CursoEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_cursos
					SET visible = ABS(visible - 1)
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PaginaEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_paginas
					SET visible = ABS(visible - 1)
					WHERE id ='$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NoticiaEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_paginas
					SET visible = ABS(visible - 1)
					WHERE id ='$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PaginaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_paginas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function PaginaEliminarI($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_paginas SET imagen = ''
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NoticiaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_paginas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PortesEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_portes
					WHERE id = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function PortesEliminarKm($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_portes_km
					WHERE id = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function PortesEliminarProvin($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_portes_provincias
					WHERE id = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function PortesEliminarProvinP($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_portes_provincias_peso
					WHERE id = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function PortesEliminarTransProvinP($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_portes_provincias_peso
					WHERE id_transp = '$id';";
			$query = mysqli_query($this->conexion, $sql);
                        
                        $sql = "DELETE FROM bd_transportista_peso
					WHERE id = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CategoriaAtributosEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_atributo_tipo
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function AtributoEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_atributo
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CursoEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_cursos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NuevoAtributo($tipoid, $nombre)
		{
			$tipoid = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipoid));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $nombre = ereg_replace("[^A-Za-z0-9,.]", "", $nombre);
			
			$sql = "INSERT INTO bd_atributo
					VALUES (null, '$tipoid', '$nombre');";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NuevoPorte($nombre, $gratisE,$precioE,$gratisC,$precioC,$gratisB,$precioB,$gratisCM,$precioCM,$gratisEU,$precioEU,$gratisI,$precioI, $extension)
		{
			$region = mysqli_real_escape_string($this->conexion, htmlspecialchars($region));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			$max = mysqli_real_escape_string($this->conexion, htmlspecialchars($max));
                        
                        if ($gratisE == '')
                            $gratisE = 'NULL';
                        else
                            $gratisE = $_POST['gratisE'];
                        if ($gratisC == '')
                            $gratisC = 'NULL';
                        else
                            $gratisC = $_POST['gratisC'];
                        if ($gratisB == '')
                            $gratisB = 'NULL';
                        else
                            $gratisB = $_POST['gratisB'];
                        if ($gratisCM == '')
                            $gratisCM = 'NULL';
                        else
                            $gratisCM = $_POST['gratisCM'];
                        if ($gratisEU == '')
                            $gratisEU = 'NULL';
                        else
                            $gratisEU = $_POST['gratisEU'];
                        if ($gratisI == '')
                            $gratisI = 'NULL';
                        else
                            $gratisI = $_POST['gratisI'];

                        if ($precioE == '')
                            $precioE = 'NULL';
                        else
                            $precioE = $_POST['precioE'];
                        if ($precioC == '')
                            $precioC = 'NULL';
                        else
                            $precioC = $_POST['precioC'];
                        if ($precioB == '')
                            $precioB = 'NULL';
                        else
                            $precioB = $_POST['precioB'];
                        if ($precioCM == '')
                            $precioCM = 'NULL';
                        else
                            $precioCM = $_POST['precioCM'];
                        if ($precioEU == '')
                            $precioEU = 'NULL';
                        else
                            $precioEU = $_POST['precioEU'];
                        if ($precioI == '')
                            $precioI = 'NULL';
                        else
                            $precioI = $_POST['precioI'];
			
			$sql = "INSERT INTO bd_portes VALUES (null, '$_POST[nombre]',$gratisE,$precioE,$gratisB,$precioB,$gratisC,$precioC,$gratisCM,$precioCM,$gratisEU,$precioEU,$gratisI,$precioI,1,'$extension')";
			$query = mysqli_query($this->conexion, $sql);

			return mysqli_insert_id($this->conexion);
		}
                
                function NuevoPorteKm($km, $precio, $extension)
		{
			$km = mysqli_real_escape_string($this->conexion, htmlspecialchars($km));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			
			$sql = "INSERT INTO bd_portes_km VALUES (null, '$km', '$precio', '$extension')";
			$query = mysqli_query($this->conexion, $sql);

			return mysqli_insert_id($this->conexion);
		}
                
                function NuevoPorteProvincia($trans, $prov, $precio)
		{
			$trans = mysqli_real_escape_string($this->conexion, htmlspecialchars($trans));
                        $prov = mysqli_real_escape_string($this->conexion, htmlspecialchars($prov));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			
			$sql = "INSERT INTO bd_portes_provincias VALUES (null, '$trans', '$prov', '$precio')";
			$query = mysqli_query($this->conexion, $sql);

			return mysqli_insert_id($this->conexion);
		}
                
                function NuevoPorteProvinciaPeso($trans, $prov, $precio)
		{
			$trans = mysqli_real_escape_string($this->conexion, htmlspecialchars($trans));
                        $prov = mysqli_real_escape_string($this->conexion, htmlspecialchars($prov));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			
			$sql = "INSERT INTO bd_portes_provincias_peso VALUES (null, '$trans', '$prov', '$precio')";
			$query = mysqli_query($this->conexion, $sql);

			return mysqli_insert_id($this->conexion);
		}
                
                function NuevaAgencia($nombre, $preciod = '0', $extension)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			
			$sql = "INSERT INTO bd_transportista VALUES (null, '$nombre', '$extension')";
			$query = mysqli_query($this->conexion, $sql);
                        $id = mysqli_insert_id($this->conexion);
                        
                        $sql2 = "INSERT INTO bd_portes_provincias VALUES (null, '$id', '0', '$preciod')";
                        $query2 = mysqli_query($this->conexion, $sql2);

			return $id;
		}
                
                function NuevaAgenciaP($nombre, $preciod = '0', $extension)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			
			$sql = "INSERT INTO bd_transportista_peso VALUES (null, '$nombre', '$extension')";
			$query = mysqli_query($this->conexion, $sql);
                        $id = mysqli_insert_id($this->conexion);
                        
                        $sql2 = "INSERT INTO bd_portes_provincias_peso VALUES (null, '$id', '0', '$preciod')";
                        $query2 = mysqli_query($this->conexion, $sql2);

			return $id;
		}
		
		function ModificarAtributo($id, $tipoid, $nombre)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$tipoid = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipoid));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $nombre = ereg_replace("[^A-Za-z0-9,.]", "", $nombre);
			
			$sql = "UPDATE bd_atributo
					SET atributo = '$nombre', tipoid = $tipoid
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
		function NuevaCategoriaAtributo($nombre, $mensaje, $obligatorio, $obligatorio2, $desglosado, $oculto, $descripcion)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $mensaje = mysqli_real_escape_string($this->conexion, htmlspecialchars($mensaje));
			//$dependiente = mysqli_real_escape_string($this->conexion, htmlspecialchars($dependiente));
                        $obligatorio = mysqli_real_escape_string($this->conexion, htmlspecialchars($obligatorio));
                        $obligatorio2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($obligatorio2));
                        $descripcion = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcion));
                        $desglosado = mysqli_real_escape_string($this->conexion, htmlspecialchars($desglosado));
                        $oculto = mysqli_real_escape_string($this->conexion, htmlspecialchars($oculto));                        
            
            /*if (@$dependiente == 'dependiente')
                $dependiente = 1;
            else
                $dependiente = 0;
            */
            if (@$obligatorio == 'obligatorio')
                $obligatorio = 'Si';
            else
                $obligatorio = 'No';
            
            if (@$obligatorio2 == 'obligatorio2')
                $obligatorio2 = 'Si';
            else
                $obligatorio2 = 'No';
            
            if (@$desglosado == 'desglosado')
                $desglosado = 'Si';
            else
                $desglosado = 'No';
            
            if ($oculto == 'oculto')
                $oculto = 'Si';
            else
                $oculto = 'No';
			
			$sql = "INSERT INTO bd_atributo_tipo
					VALUES (null, '$nombre', '$obligatorio', '$obligatorio2', '$descripcion', '$desglosado', '$oculto', '$mensaje');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ModificarCategoriaAtributo($id, $nombre, $mensaje, $dependiente, $dependiente2, $desglosado, $oculto, $descripcion)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $mensaje = mysqli_real_escape_string($this->conexion, htmlspecialchars($mensaje));
			$dependiente = mysqli_real_escape_string($this->conexion, htmlspecialchars($dependiente));
                        $dependiente2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($dependiente2));
                        $descripcion = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcion));
                        $desglosado = mysqli_real_escape_string($this->conexion, htmlspecialchars($desglosado));
                        $oculto = mysqli_real_escape_string($this->conexion, htmlspecialchars($oculto));
			
                        if($dependiente == 'obligatorio')
                            $obligatorio = 'Si';
                        else
                            $obligatorio = 'No';
                        
                        if($dependiente2 == 'obligatorio2')
                            $obligatorio2 = 'Si';
                        else
                            $obligatorio2 = 'No';
                        
                        if($desglosado == 'desglosado')
                            $desglosado = 'Si';
                        else
                            $desglosado = 'No';
                        
                        if($oculto == 'oculto')
                            $oculto = 'Si';
                        else
                            $oculto = 'No';
                        
			$sql = "UPDATE bd_atributo_tipo
					SET atributo = '$nombre', mensaje = '$mensaje', obligatorio = '$obligatorio', obligatorio2 = '$obligatorio2', descripcion = '$descripcion', desglosado = '$desglosado', oculto = '$oculto'
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function FacturaNueva($idcompra)
		{
            $id = 0;
			$idcompra = mysqli_real_escape_string($this->conexion, htmlspecialchars($idcompra));
            
			$sql = "SELECT *
					FROM bd_compra
                    WHERE estado IN ('transferencia', 'contrareembolso', 'tienda', 'domiciliacion', 'domiciliacionSubscripcion', 'financiacionDirecta', 'tarjeta')
                    AND id = $idcompra;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
                $sql = "INSERT INTO bd_facturas
                        VALUES (null, null, ($assoc[precio]+$assoc[portes]), $assoc[precio], null, $assoc[abono], $assoc[portes], $assoc[idusuario], NOW(), '$assoc[estado]', null, null, 1, '$assoc[secreto]', '', null, null, ".date('Y').", null, null, null, null, null, '$assoc[cambio]', '$assoc[monedaWeb]', '$assoc[monedaUser]');";
                $query = mysqli_query($this->conexion, $sql);
                $id = mysqli_insert_id($this->conexion);
                $sql = "UPDATE bd_compra
                        SET estado = 'pagado'
                        WHERE estado IN ('transferencia', 'contrareembolso', 'tienda', 'domiciliacion', 'domiciliacionSubscripcion', 'financiacionDirecta', 'tarjeta')
                        AND id = $idcompra;";
                $query = mysqli_query($this->conexion, $sql);
			}
			
			return $id;
		}
		
		function MenuNuevo($nombre, $url = '', $descripcion, $imagen, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer, $padre = null, $categoria = null)
		{
			$siguiente = 1;
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
                        $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
                        $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
                        $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
                        $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
                        $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
                        $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
                        $descripcion = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcion));
                        $url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
			
			if ($padre != null)
				$idpadre = '= '.$padre;
			else
			{
				$padre = 'NULL';
				$idpadre = 'IS '.$padre;
			}
			
			if ($categoria != null)
				$categoria = 1;
            else
                $categoria = 0;
            
            $imgname = "null";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.$imagen['name'];
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = "'$imgname'";
			}
			
			$sql = "SELECT MAX(orden) AS siguiente
					FROM bd_menu
					WHERE id_padre $idpadre
					ORDER BY id ASC, orden ASC;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$siguiente += $assoc['siguiente'];
			}
			
			$sql = "INSERT INTO bd_menu
					VALUES (null, '$nombre', $siguiente, $padre, $categoria, $imgname, '$descripcion', '$url');";
                        
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT MAX(id) AS id FROM bd_menu";
            $query2 = mysqli_query($this->conexion, $sql);
            $id = mysqli_fetch_array($query2);
            
            if($nombrein != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'UK', '$nombrein');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrea != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'DEU', '$nombrea');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombref != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'FRA', '$nombref');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombreit != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'ITA', '$nombreit');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrep != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'POR', '$nombrep');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrec != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'CAT', '$nombrec');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrer != null){    
                $sql = "INSERT INTO bd_categoria_idioma
					VALUES (null, $id[id], 'RUS', '$nombrer');";
			     mysqli_query($this->conexion, $sql);
            }
            
			return $query;
		}
		
		function MenuModificar($id, $url = '', $descripcion, $imagen, $nombre, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer, $padre = null, $categoria = null)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
                        $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
                        $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
                        $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
                        $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
                        $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
                        $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
                        $descripcion = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcion));
                        $descripcion = html_entity_decode($descripcion);
                        $url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
			
			if ($padre == null)
				$padre = 'NULL';
			
			if ($categoria != null)
				$categoria = 1;
            else
                $categoria = 0;
            
            $imgname = "";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.$imagen['name'];
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}

			
			$sql = "UPDATE bd_menu
					SET nombre = '$nombre', id_padre = $padre, categoria = $categoria, descripcion = '$descripcion' $imgname, url = '$url'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'UK';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombrein'
                        WHERE idcategoria = $id AND idioma = 'UK';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrein != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'UK', '$nombrein');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'DEU';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombrea'
                        WHERE idcategoria = $id AND idioma = 'DEU';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrea != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'DEU', '$nombrea');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'FRA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombref'
                        WHERE idcategoria = $id AND idioma = 'FRA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombref != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'FRA', '$nombref');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'ITA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombreit'
                        WHERE idcategoria = $id AND idioma = 'ITA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'ITA', '$nombreit');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'POR';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombrep'
                        WHERE idcategoria = $id AND idioma = 'POR';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'POR', '$nombrep');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'CAT';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombrec'
                        WHERE idcategoria = $id AND idioma = 'CAT';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'CAT', '$nombrec');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_categoria_idioma
                    WHERE idcategoria = $id AND idioma = 'RUS';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_categoria_idioma
                        SET nombre = '$nombrer'
                        WHERE idcategoria = $id AND idioma = 'RUS';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_categoria_idioma
                            VALUES (null, $id, 'RUS', '$nombrer');";
                    mysqli_query($this->conexion, $sql);
                }
            }
			
			return $query;
		}
		
        function CargarIdiomas($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_idiomas
                    WHERE activo = 1
					ORDER BY id ASC";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarIdiomasM($id)
		{
			$resultado = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_categoria_idioma
					WHERE idcategoria = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado[] = $assoc;
			}

			return $resultado;
		}
        
        function CargarIdiomasCB($id)
		{
			$resultado = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_catblog_idioma
					WHERE idcatblog = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado[] = $assoc;
			}

			return $resultado;
		}
        
        function CargarIdiomasCG($id)
		{
			$resultado = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_catgaleria_idioma
					WHERE idcatgaleria = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado[] = $assoc;
			}

			return $resultado;
		}
        
        function CargarIdProducto($id)
		{
            $resultado = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_producto_idioma
                    WHERE id_producto = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado[] = $assoc;
			}

			return $resultado;
		}
        
        function CargarIdNoticia($id)
		{
            $resultado = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_blog_idioma
                    WHERE idblog = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado[] = $assoc;
			}

			return $resultado;
		}
        
		function MenuEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_menu
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ImagenProductoNueva($id, $img)
		{
			if ($img['error'] != 4)
			{
                                $sql = "SELECT nombre FROM bd_productos WHERE id = '$id'";
                                $query = mysqli_query($this->conexion, $sql);
                                if (mysqli_num_rows($query) > 0){
                                    $assoc = mysqli_fetch_assoc($query);
                                    $imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $assoc['nombre']))) . "." . strtolower(end(explode(".", $img['name'])));
                                }else{
                                    $imgname = uniqid().'_'.$img['name'];
                                }
                            
				move_uploaded_file($img['tmp_name'], '../imagenesproductos/'.$imgname);
				
				$sql = "INSERT INTO bd_fotos
						VALUES (null, $id, '$imgname');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
			
			return $query;
		}
                
                function ImagenBlogNueva($id, $img)
		{
			if ($img['error'] != 4)
			{
				$sql = "SELECT nombre FROM bd_paginas WHERE id = '$id'";
                                $query = mysqli_query($this->conexion, $sql);
                                $assoc = mysqli_fetch_assoc($query);
				
                                $sql2 = "SELECT * FROM bd_fotos_blog WHERE idblog = '$id'";
                                $query2 = mysqli_query($this->conexion, $sql2);
                                $numero = mysqli_num_rows($query2);
                                $numero++;
                                
                                $imgname = strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $assoc['nombre'])));
                                $imgname .= "_" . $numero . "." . strtolower(end(explode(".", $img['name'])));
                                $imgname = mysqli_real_escape_string($this->conexion, htmlspecialchars($imgname));
				//$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				
				$sql = "INSERT INTO bd_fotos_blog
						VALUES (null, $id, '$imgname');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
			
			return $query;
		}
		
		function SliderNuevo($texto, $categoria, $texto_en = null, $texto_fr = null, $texto_al = null, $texto_it = null, $texto_po = null, $texto_ca = null, $texto_ru = null, $img, $titulo, $url, $destino)
		{
			$siguiente = 1;
			$texto = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto));
                        $texto_en = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_en));
                        $texto_fr = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_fr));
                        $texto_al = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_al));
                        $texto_it = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_it));
                        $texto_po = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_po));
                        $texto_ca = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_ca));
                        $texto_ru = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto_ru));
                        $titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
                        $url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
                        $destino = mysqli_real_escape_string($this->conexion, htmlspecialchars($destino));
			
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], './uploads/'.$imgname);
				$sql = "SELECT MAX(orden) AS siguiente
						FROM bd_slider
						ORDER BY id ASC, orden ASC;";
				$query = mysqli_query($this->conexion, $sql);
				
				if (mysqli_num_rows($query) == 1)
				{
					$assoc = mysqli_fetch_assoc($query);
					$siguiente += $assoc['siguiente'];
				}
				
				$sql = "INSERT INTO bd_slider
						VALUES (null, $categoria, '$imgname', $siguiente, '$texto', '$texto_en', '$texto_al', '$texto_fr', '$texto_it', '$texto_po', '$texto_ca', '$texto_ru', 0, '$titulo', '$url', $destino);";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
			
			return $query;
		}
        
        function ImagenCatNuevo($categoria, $img)
		{
			$siguiente = 1;
			$texto = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto));
			
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenesproductos/'.$imgname);
				
				$sql = "INSERT INTO bd_imagen_categoria
						VALUES (null, $categoria, '$imgname');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
			
			return $query;
		}
        
        function GaleriaNuevo($categoria, $img, $text1, $img2, $text2, $img3, $text3, $img4, $text4, $img5, $text5)
		{
			
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $img['name'])));
                                
				move_uploaded_file($img['tmp_name'], '../imagenes/galeria/'.$imgname);
				
				$text1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($text1));
				
				$sql = "INSERT INTO bd_galeria
						VALUES (null, '$imgname', $categoria, '$text1');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
                        if ($img2['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $img2['name'])));
                                
				move_uploaded_file($img2['tmp_name'], '../imagenes/galeria/'.$imgname);
				
				$text2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($text2));
				
				$sql = "INSERT INTO bd_galeria
						VALUES (null, '$imgname', $categoria, '$text2');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
                        if ($img3['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $img3['name'])));
                                
				move_uploaded_file($img3['tmp_name'], '../imagenes/galeria/'.$imgname);
				
				$text3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($text3));
				
				$sql = "INSERT INTO bd_galeria
						VALUES (null, '$imgname', $categoria, '$text3');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
                        if ($img4['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $img4['name'])));
                                
				move_uploaded_file($img4['tmp_name'], '../imagenes/galeria/'.$imgname);
				
				$text4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($text4));
				
				$sql = "INSERT INTO bd_galeria
						VALUES (null, '$imgname', $categoria, '$text4');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
                        if ($img5['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $img5['name'])));
                                
				move_uploaded_file($img5['tmp_name'], '../imagenes/galeria/'.$imgname);
				
				$text5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($text5));
				
				$sql = "INSERT INTO bd_galeria
						VALUES (null, '$imgname', $categoria, '$text5');";
				$query = mysqli_query($this->conexion, $sql);
			}
			else
				$query = false;
			
			return $query;
		}
        
        function GaleriaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_galeria
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function SliderEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_slider
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ImagenCatEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_imagen_categoria
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ImagenProductoEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_fotos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function ImagenBlogEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_fotos_blog
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CargarContadores()
		{
            $contadores = array();
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_productos
					WHERE disponible = 0;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['productosv'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_productos
					WHERE disponible = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['productoso'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_pack";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['packs'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_compra
					WHERE estado = 'contrareembolso';";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['contrareembolso'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_compra
					WHERE estado = 'transferencia';";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['transferencias'] = $assoc['contador'];
			}
            
			/*$sql = "SELECT COUNT(id) AS contador
					FROM bd_compra
					WHERE estado IN ('transferencia', 'paypal', 'domiciliacion', 'contrareembolso', 'tienda', 'pendiente de pago');";*/
                        $sql = "SELECT COUNT(id) AS contador
					FROM bd_compra
					WHERE estado IN ('transferencia', 'paypal', 'domiciliacion', 'contrareembolso', 'tienda');";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['compras_pendientes'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_users
					WHERE rol = 2 OR rol = 0;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['usuarios'] = $assoc['contador'];
			}
            
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_users
					WHERE rol = 2;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['usuariosr'] = $assoc['contador'];
			}
            //$date = date('Y-m-d');
			$sql = "SELECT COUNT(id) AS contador
					FROM bd_facturas
					WHERE fecha >= date_add(NOW(), INTERVAL -1 DAY);";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['facturas'] = $assoc['contador'];
			}
            
            $sql = "SELECT COUNT(id) AS contador
					FROM bd_carrito;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['carritos'] = $assoc['contador'];
			}
            
            $sql = "SELECT COUNT(id) AS contador
					FROM bd_distribuidores;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$contadores['distribuidores'] = $assoc['contador'];
			}
            
            return $contadores;
		}
		
		function CargarEmpresa()
		{
			$sql = "SELECT *
					FROM bd_empresa
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$this->setEmpresa($assoc);
			}
		}
        
        function CargarGalerias()
		{
			$sql = "SELECT *
					FROM bd_galeria";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
                
        function CargarGaleriasFeed()
		{
			$sql = "SELECT g.imagen AS imagen, cg.nombre AS nombre
					FROM bd_galeria g, bd_categoria_galeria cg
                                        WHERE g.idcat = cg.id";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
        
        function CargarActGaleria()
		{
			$sql = "SELECT galeria
					FROM bd_empresa";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
        
        function CargarActBlog()
		{
			$sql = "SELECT blog
					FROM bd_empresa";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
        
        function CargarActBlogIn()
		{
			$sql = "SELECT blogin
					FROM bd_empresa";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
		
		function Empresa($clave)
		{
			if (@$this->empresa[$clave] != null)
				return $this->empresa[$clave];
			else
				return null;
		}
		
		function UsuarioNuevo($nombre, $nif, $telefono, $email, $calle, $provincia, $poblacion, $cp, $pass)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$nif = mysqli_real_escape_string($this->conexion, htmlspecialchars($nif));
			$telefono = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono));
			$email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$calle = mysqli_real_escape_string($this->conexion, htmlspecialchars($calle));
			$provincia = mysqli_real_escape_string($this->conexion, htmlspecialchars($provincia));
			$poblacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($poblacion));
			$cp = mysqli_real_escape_string($this->conexion, htmlspecialchars($cp));
			$pass = mysqli_real_escape_string($this->conexion, $this->filtropass(htmlspecialchars($pass)));
			
			/*$sql = "INSERT INTO bd_users
					VALUES (NULL, '$nombre', '$pass', 2, '$email', '$telefono', '$calle', '', 'Registrado', '$nif', '$cp', '$poblacion', $provincia, 'ESP', 0, 'A');";*/
			$sql = "INSERT INTO bd_users
					VALUES (NULL, '$nombre','', '$pass', 1, '$email', '$telefono', '$calle', '', 'Registrado', '$nif', '$cp', '$poblacion', $provincia, 'ESP', 0, 'A','Empresa','CIF');";
			//Ejemplo de salida de datos
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function DistribuidorNuevo($nombre, $apellidos, $razonsocial, $nif, $telefono, $email, $calle, $provincia, $poblacion, $cp, $pass, $paypal)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $apellidos = mysqli_real_escape_string($this->conexion, htmlspecialchars($apellidos));
                        $razonsocial = mysqli_real_escape_string($this->conexion, htmlspecialchars($razonsocial));
			$nif = mysqli_real_escape_string($this->conexion, htmlspecialchars($nif));
			$telefono = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono));
			$email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$calle = mysqli_real_escape_string($this->conexion, htmlspecialchars($calle));
			$provincia = mysqli_real_escape_string($this->conexion, htmlspecialchars($provincia));
			$poblacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($poblacion));
			$cp = mysqli_real_escape_string($this->conexion, htmlspecialchars($cp));
			$pass = mysqli_real_escape_string($this->conexion, $this->filtropass(htmlspecialchars($pass)));
                        $paypal = mysqli_real_escape_string($this->conexion, htmlspecialchars($paypal));
			
			$sql = "INSERT INTO bd_distribuidores
					VALUES (null, '$razonsocial', '$nombre', '$apellidos','$nif', '$email', '$pass', '$telefono', '$calle', '$poblacion', $provincia, '$cp', 'R', '$paypal');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
         
        function DistribuidorEliminar($id){
                         $sql = "DELETE FROM bd_distribuidores WHERE id = '$id'";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
                }       
		
		function UsuarioModificar($id, $nombre, $nif, $telefono, $email, $direccion, $provincia, $poblacion, $cp, $pass = null)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$nif = mysqli_real_escape_string($this->conexion, htmlspecialchars($nif));
			$telefono = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono));
			$email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$direccion = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccion));
			$provincia = mysqli_real_escape_string($this->conexion, htmlspecialchars($provincia));
			$poblacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($poblacion));
			$cp = mysqli_real_escape_string($this->conexion, htmlspecialchars($cp));
			
			if ($pass != null)
			{
				$pass = mysqli_real_escape_string($this->conexion, $this->filtropass(htmlspecialchars($pass)));
				$pass = ", pass = '$pass'";
			}
			
			$sql = "UPDATE bd_users
					SET nombre = '$nombre', dni = '$nif', telefono = '$telefono',
                        email = '$email', provincia = $provincia, poblacion = '$poblacion',
                        direccion = '$direccion', cp = '$cp'$pass
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ActivarGaleria($activacion)
		{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET galeria = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ActualizarNGaleria($nombre)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			
			$sql = "UPDATE bd_empresa
					SET ngaleria = '$nombre'
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ActivarBlog($activacion)
		{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET blog = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function CambiarNBlog($nombre)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			
			$sql = "UPDATE bd_empresa
					SET nblog = '$nombre'
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function CargarNombreGalería(){
                        $sql = "SELECT ngaleria FROM bd_empresa WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
                        
                        $assoc = mysqli_fetch_assoc($query);
			return $assoc;
        }
        
        function CargarNombreBlog(){
                        $sql = "SELECT nblog FROM bd_empresa WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
                        
                        $assoc = mysqli_fetch_assoc($query);
			return $assoc;
        }
        
        function ActivarBlogIn($activacion)
		{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET blogin = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function DistribuidorModificar($id, $nombre, $apellidos, $razonsocial, $nif, $telefono, $email, $direccion, $provincia, $poblacion, $cp, $paypal, $pass = null)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $apellidos = mysqli_real_escape_string($this->conexion, htmlspecialchars($apellidos));
                        $razonsocial = mysqli_real_escape_string($this->conexion, htmlspecialchars($razonsocial));
			$nif = mysqli_real_escape_string($this->conexion, htmlspecialchars($nif));
			$telefono = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono));
			$email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$direccion = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccion));
			$provincia = mysqli_real_escape_string($this->conexion, htmlspecialchars($provincia));
			$poblacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($poblacion));
			$cp = mysqli_real_escape_string($this->conexion, htmlspecialchars($cp));
                        $paypal = mysqli_real_escape_string($this->conexion, htmlspecialchars($paypal));
			
			if ($pass != null)
			{
				$pass = mysqli_real_escape_string($this->conexion, $this->filtropass(htmlspecialchars($pass)));
				$pass = ", pass = '$pass'";
			}
			
			$sql = "UPDATE bd_distribuidores
					SET nombre = '$nombre', apellidos = '$apellidos', razonsocial = '$razonsocial', dni = '$nif', telefono = '$telefono',
                        email = '$email', provincia = $provincia, poblacion = '$poblacion', paypal = '$paypal',
                        direccion = '$direccion', cp = '$cp'$pass
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
	function PackNuevo($nombre, $descripcion, $imagen, $precio, $iva, $descuento)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			$iva = mysqli_real_escape_string($this->conexion, htmlspecialchars($iva));
			$descuento = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuento));
            
                        $imgname = "null";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.$imagen['name'];
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = "'$imgname'";
			}
			
			$sql = "INSERT INTO bd_pack
					VALUES (null, '$nombre', '$descripcion', $descuento, $precio, $iva, 0, $imgname, 0);";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PackModificar($id, $nombre, $descripcion, $imagen, $precio, $iva, $descuento)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			$iva = mysqli_real_escape_string($this->conexion, htmlspecialchars($iva));
			$descuento = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuento));
            
            $imgname = "";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.$imagen['name'];
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}
			
			$sql = "UPDATE bd_pack
					SET nombre = '$nombre', descripcion = '$descripcion', precio = $precio,
                    iva = $iva, descuento = $descuento$imgname
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function CargarAtributoProds($id)
		{
            $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_producto_atributo
                    WHERE idproducto = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function ProductoEditarAtr($atr, $idp, $precio, $precioE, $url){
            $sql = "SELECT *
					FROM bd_producto_atributo
                    WHERE idproducto = $idp AND idatributo = $atr;";
            $query = mysqli_query($this->conexion, $sql);
            $cadena = '';
            if(mysqli_num_rows($query) == 1){
                if(strcmp($url, 'noModif') != 0){ $cadena = "AND url = '".$url."'"; }
                $sql = "UPDATE bd_producto_atributo
                        SET precio = $precio, precioextra = $precioE $cadena
                        WHERE idproducto = $idp AND idatributo = $atr;";
                $query2 = mysqli_query($this->conexion, $sql);
            }else{
                    $sql = "INSERT INTO bd_producto_atributo
                            VALUES (null, $atr, $idp, $precio, $precioE, '$url');";
               
                $query2 = mysqli_query($this->conexion, $sql);
            }
        }
        
        function EliminarAtrs($idp){
            $dev = array();
            $sql = "SELECT * FROM bd_producto_atributo
                    WHERE idproducto = $idp;";
            $query = mysqli_query($this->conexion, $sql);
            if (mysqli_num_rows($query) > 0){
		while ($assoc = mysqli_fetch_assoc($query))
                    $dev[$assoc['idatributo']] = $assoc['imagen'];
            }
                    
            $sql = "DELETE FROM bd_producto_atributo
                    WHERE idproducto = $idp;";
            mysqli_query($this->conexion, $sql);
            
            return $dev;
        }
		
		function ProductoNuevo($disponible, $nombre, $descripcion, $nombrein, $descripcionin, $nombrea, $descripciona, $nombref, $descripcionf, $nombreit, $descripcionit, $nombrep, $descripcionp, $nombreca, $descripcionca, $nombreru, $descripcionru, $imagen, $metatitulo, $metadescripcion, $unidades, $stock, $precio, $tprecio, $comprecio, $iva, $descuento, $descuentoe, $peso, $referencia, $orden = null, $disponibilidad, $plazoEnt, $categorias, $marca = null, $paypalm, $domicim, $fDirecta, $aplazame, $caplazame, $caplazame1, $pagotado, $agotado, $tipo, $NCatAtriF, $nfentrada = null, $nfsalida = null, $mostraretq = null, $mostraretqAgo = null, $mostraretqOfe = null, $maxDias = 0)
		{
			if($categorias[0])
			$cat=$categorias[0];
			else
			$cat = NULL;
			if($categorias[1])
			$cat1=$categorias[1];
			else
			$cat1 = NULL;
			if($categorias[2])
			$cat2=$categorias[2];
			else
			$cat2 = NULL;
			if($categorias[3])
			$cat=$categorias[3];
			else
			$cat3 = NULL;
			if($categorias[4])
			$cat4=$categorias[4];
			else
			$cat4 = NULL;
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
                        $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
			$descripcionin = mysqli_real_escape_string($this->conexion, $descripcionin);
                        $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
			$descripciona = mysqli_real_escape_string($this->conexion, $descripciona);
                        $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
			$descripcionf = mysqli_real_escape_string($this->conexion, $descripcionf);
                        $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
			$descripcionit = mysqli_real_escape_string($this->conexion, $descripcionit);
                        $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
			$descripcionp = mysqli_real_escape_string($this->conexion, $descripcionp);
                        $nombreca = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreca));
			$descripcionca = mysqli_real_escape_string($this->conexion, $descripcionca);
                        $nombreru = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreru));
			$descripcionru = mysqli_real_escape_string($this->conexion, $descripcionru);
                        $metatitulo = mysqli_real_escape_string($this->conexion, $metatitulo);
                        $metadescripcion = mysqli_real_escape_string($this->conexion, $metadescripcion);
			$unidades = mysqli_real_escape_string($this->conexion, htmlspecialchars($unidades));
			$stock = mysqli_real_escape_string($this->conexion, htmlspecialchars($stock));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
                        $tprecio = mysqli_real_escape_string($this->conexion, htmlspecialchars($tprecio));
                        $comprecio = mysqli_real_escape_string($this->conexion, htmlspecialchars($comprecio));
			$iva = mysqli_real_escape_string($this->conexion, htmlspecialchars($iva));
			$descuento = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuento));
			$descuentoe = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuentoe));
			$peso = mysqli_real_escape_string($this->conexion, htmlspecialchars($peso));
			$referencia = mysqli_real_escape_string($this->conexion, htmlspecialchars($referencia));
                        $disponibilidad = mysqli_real_escape_string($this->conexion, htmlspecialchars($disponibilidad));
			$plazoEnt = mysqli_real_escape_string($this->conexion, htmlspecialchars($plazoEnt));
			$cat = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat));
                        $paypalm = mysqli_real_escape_string($this->conexion, htmlspecialchars($paypalm));
                        $domicim = mysqli_real_escape_string($this->conexion, htmlspecialchars($domicim));
                        $fDirecta = mysqli_real_escape_string($this->conexion, htmlspecialchars($fDirecta));
                        $tipo = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipo));
                        $pagotado = mysqli_real_escape_string($this->conexion, htmlspecialchars($pagotado));
                        $agotado = mysqli_real_escape_string($this->conexion, htmlspecialchars($agotado));
                        $aplazame = mysqli_real_escape_string($this->conexion, htmlspecialchars($aplazame));
                        $caplazame = mysqli_real_escape_string($this->conexion, htmlspecialchars($caplazame));
                        $caplazame1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($caplazame1));
                        $NCatAtriF = mysqli_real_escape_string($this->conexion, htmlspecialchars($NCatAtriF));
                        $maxDias = mysqli_real_escape_string($this->conexion, htmlspecialchars($maxDias));
            
            if ($cat1 != null && $cat1 != '')
                $cat1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat1));
            else
                $cat1 = '0';
	    if ($cat2 != null && $cat2 != '')
                $cat2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat2));
            else
                $cat2 = '0';
            if ($cat3 != null && $cat3 != '')
                $cat3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat3));
            else
                $cat3 = '0';
	    if ($cat4 != null && $cat4 != '')
                $cat4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat4));
            else
                $cat4 = '0';
            if ($marca != null && $marca != '')
                $marca = mysqli_real_escape_string($this->conexion, htmlspecialchars($marca));
            else
                $marca = '0';
            
            if ($orden != null && $orden != '')
                $orden = mysqli_real_escape_string($this->conexion, htmlspecialchars($orden));
            else
                $orden = 'NULL';
            
           
            if ($disponible != null)
                $disponible = 1;
            else
                $disponible = 0;
            
            if ($mostraretq != null)
                $mostraretq = 1;
            else
                $mostraretq = 0;
            
            if ($mostraretqAgo != null)
                $mostraretqAgo = 1;
            else
                $mostraretqAgo = 0;
            
            if ($mostraretqOfe != null)
                $mostraretqOfe = 1;
            else
                $mostraretqOfe = 0;
            
            if ($nfentrada != null)
                $nfentrada = 1;
            else
                $nfentrada = 0;
            
            if ($nfsalida != null)
                $nfsalida = 1;
            else
                $nfsalida = 0;
            
            
            
            if($aplazame == 0){
                $caplazame = 'NULL';
                $caplazame1 = 'NULL';
            }
            
            $imgname = "null";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $nombre))) . "." . strtolower(end(explode(".", $imagen['name'])));
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = "'$imgname'";
			}
			
			$sql = "INSERT INTO bd_productos
					VALUES (null, '$nombre', '$nombrein', '$descripcion', '$descripcionin', $imgname, $unidades, $stock, $precio, '$tprecio', '$comprecio', 0, '$descuento', '$descuentoe', $cat, $cat1, $cat2, $cat3, $cat4, $marca, 0, $peso, '$referencia', $iva, $disponible, 0, 0, '$metatitulo', '$metadescripcion', 0, $tipo, $paypalm, $domicim, $fDirecta, $aplazame, $caplazame, $caplazame1, $nfentrada, $nfsalida, $NCatAtriF, 0, '$mostraretq', '$mostraretqAgo', '$mostraretqOfe', '$maxDias', '$disponibilidad', '$plazoEnt', $orden, '$pagotado', '$agotado');";
                                           
			$query = mysqli_query($this->conexion, $sql);
                         
            $sql = "SELECT MAX(id) AS id FROM bd_productos";
            $query2 = mysqli_query($this->conexion, $sql);
            $id = mysqli_fetch_array($query2);
            
            $sql = "UPDATE bd_producto_atributo SET idproducto = $id[id] WHERE idproducto = 0;";
            mysqli_query($this->conexion, $sql);
            
            $sql = "UPDATE bd_producto_etiqueta SET idproducto = $id[id] WHERE idproducto = 0;";
            mysqli_query($this->conexion, $sql);
            
            $sql = "UPDATE bd_productos_fdirecta SET idproducto = $id[id] WHERE idproducto = 0;";
            mysqli_query($this->conexion, $sql);
            
            if($nombrein != null || $descripcionin != null){    
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'UK', '$nombrein', '$descripcionin');";
			     mysqli_query($this->conexion, $sql);
            }
            if($nombrea != null || $descripciona != null){
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'DEU', '$nombrea', '$descripciona');";
			     mysqli_query($this->conexion, $sql);
            }
            if($nombref != null || $descripcionf != null){
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'FRA', '$nombref', '$descripcionf');";
			     mysqli_query($this->conexion, $sql);
            }
            if($nombreit != null || $descripcionit != null){
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'ITA', '$nombreit', '$descripcionit');";
			     mysqli_query($this->conexion, $sql);
            }
           if($nombrep != null || $descripcionp != null){ 
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'POR', '$nombrep', '$descripcionp');";
			     mysqli_query($this->conexion, $sql);
            }
            if($nombreca != null || $descripcionca != null){
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'CAT', '$nombreca', '$descripcionca');";
			     mysqli_query($this->conexion, $sql);
            }
           if($nombreru != null || $descripcionru != null){ 
                $sql = "INSERT INTO bd_producto_idioma
					VALUES (null, $id[id], 'RUS', '$nombreru', '$descripcionru');";
			     mysqli_query($this->conexion, $sql);
            }
			return $query;
		}
		
		function ProductoModificar($id, $nombre, $descripcion, $nombrein, $descripcionin, $nombrea, $descripciona, $nombref, $descripcionf, $nombreit, $descripcionit, $nombrep, $descripcionp, $nombrec, $descripcionc, $nombrer, $descripcionr, $imagen, $metatitulo, $metadescripcion, $unidades, $stock, $precio, $tprecio, $comprecio, $iva, $descuento, $descuentoe, $peso, $referencia, $disponibilidad, $plazoEnt, $cat1, $cat2 = null, $cat3 = null, $cat4 = null, $cat5 = null, $marca = null, $orden = null, $paypalm, $domicim, $fDirecta, $Aplazame, $caplazame, $caplazame1, $pagotado, $agotado, $tipo, $CatAtriF, $disponible = null, $nfentrada = null, $nfsalida = null, $mostraretq = null, $mostraretqAgo = null, $mostraretqOfe = null, $MaxDias = 0, $nombreF)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
                        $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
			$descripcionin = mysqli_real_escape_string($this->conexion, $descripcionin);
                        $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
			$descripciona = mysqli_real_escape_string($this->conexion, $descripciona);
                        $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
			$descripcionf = mysqli_real_escape_string($this->conexion, $descripcionf);
                        $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
			$descripcionit = mysqli_real_escape_string($this->conexion, $descripcionit);
                        $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
			$descripcionp = mysqli_real_escape_string($this->conexion, $descripcionp);
                        $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
			$descripcionc = mysqli_real_escape_string($this->conexion, $descripcionc);
                        $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			$descripcionr = mysqli_real_escape_string($this->conexion, $descripcionr);
                        $metatitulo = mysqli_real_escape_string($this->conexion, $metatitulo);
                        $metadescripcion = mysqli_real_escape_string($this->conexion, $metadescripcion);
			$unidades = mysqli_real_escape_string($this->conexion, htmlspecialchars($unidades));
			$stock = mysqli_real_escape_string($this->conexion, htmlspecialchars($stock));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
                        $tprecio = mysqli_real_escape_string($this->conexion, htmlspecialchars($tprecio));
                        $comprecio = mysqli_real_escape_string($this->conexion, htmlspecialchars($comprecio));
			$iva = mysqli_real_escape_string($this->conexion, htmlspecialchars($iva));
			$descuento = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuento));
			$descuentoe = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuentoe));
			$peso = mysqli_real_escape_string($this->conexion, htmlspecialchars($peso));
			$referencia = mysqli_real_escape_string($this->conexion, htmlspecialchars($referencia));
                        $disponibilidad = mysqli_real_escape_string($this->conexion, htmlspecialchars($disponibilidad));
			$plazoEnt = mysqli_real_escape_string($this->conexion, htmlspecialchars($plazoEnt));
			$cat1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat1));
                        $paypalm = mysqli_real_escape_string($this->conexion, htmlspecialchars($paypalm));
                        $domicim = mysqli_real_escape_string($this->conexion, htmlspecialchars($domicim));
                        $tipo = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipo));
                        $pagotado = mysqli_real_escape_string($this->conexion, htmlspecialchars($pagotado));
                        $agotado = mysqli_real_escape_string($this->conexion, htmlspecialchars($agotado));
                        $fDirecta = mysqli_real_escape_string($this->conexion, htmlspecialchars($fDirecta));
                        $Aplazame = mysqli_real_escape_string($this->conexion, htmlspecialchars($Aplazame));
                        $caplazame = mysqli_real_escape_string($this->conexion, htmlspecialchars($caplazame));
                        $caplazame1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($caplazame1));
                        $CatAtriF = mysqli_real_escape_string($this->conexion, htmlspecialchars($CatAtriF));
                        $MaxDias = mysqli_real_escape_string($this->conexion, htmlspecialchars($MaxDias));
                        $nombreF = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreF));
            
            if ($cat2 != null && $cat2 != '')
                $cat2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat2));
            else
                $cat2 = 'null';
            
            if ($cat3 != null && $cat3 != '')
                $cat3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat3));
            else
                $cat3 = 'null';
            
            if ($cat4 != null && $cat4 != '')
                $cat4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat4));
            else
                $cat4 = 'null';
            
            if ($cat5 != null && $cat5 != '')
                $cat5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($cat5));
            else
                $cat5 = 'null';
            
            if ($marca != null && $marca != '')
                $marca = mysqli_real_escape_string($this->conexion, htmlspecialchars($marca));
            else
                $marca = 'null';
            
            if ($orden != null && $orden != '')
                $orden = mysqli_real_escape_string($this->conexion, htmlspecialchars($orden));
            else
                $orden = 'NULL';
            
            if ($disponible != null)
                $disponible = 1;
            else
                $disponible = 0;
            
            if ($mostraretq != null)
                $mostraretq = 1;
            else
                $mostraretq = 0;
            
            if ($mostraretqAgo != null)
                $mostraretqAgo = 1;
            else
                $mostraretqAgo = 0;
            
            if ($mostraretqOfe != null)
                $mostraretqOfe = 1;
            else
                $mostraretqOfe = 0;
            
            if($nfentrada != null){
                $nfentrada = 1;
            }else{
                $nfentrada = 0;
            }
            
            if($nfsalida != null){
                $nfsalida = 1;
            }else{
                $nfsalida = 0;
            }
            
            $imgname = "";
			if ($imagen['error'] != 4)
			{
				$imgname = uniqid().'_'.strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $nombre))) . "." . strtolower(end(explode(".", $imagen['name'])));
				move_uploaded_file($imagen['tmp_name'], '../imagenesproductos/'.$imgname);
				$imgname = ", imagenprincipal = '$imgname'";
			}
			
                        if($Aplazame == 0){
                            $caplazame = 'NULL';
                            $caplazame1 = 'NULL';
                        }
                        
			$sql = "UPDATE bd_productos
					SET nombre = '$nombre', descripcion = '$descripcion', unidades = $unidades, meta_titulo = '$metatitulo', DiasMax = '$MaxDias', orden = $orden,
                    meta_descripcion = '$metadescripcion', stockminimo = $stock, precio = $precio, iva = $iva, descuento = $descuento, mostraretq = '$mostraretq', mostraretqOfe = '$mostraretqOfe',
                    descuentoe = $descuentoe, idcat = $cat1, idcat2 = $cat2, idcat3 = $cat3, atributoAsociado = '$CatAtriF', tprecio = '$tprecio', comprecio = '$comprecio', mostraretqAgo = '$mostraretqAgo',
                    idcat4 = $cat4, idcat5 = $cat5, idmarca = $marca, paypalm = $paypalm, domicim = $domicim, fDirecta = $fDirecta, aplazame = $Aplazame, caplazame = $caplazame, caplazame1 = $caplazame1, pagotado = '$pagotado', agotado = '$agotado', tipo= '$tipo', peso = $peso, referencia = '$referencia', disponibilidad = '$disponibilidad', plazoEnt = '$plazoEnt', disponible = $disponible, rfentrada = $nfentrada, rfsalida = $nfsalida $imgname
                    WHERE id = $id;";
                        
			$query = mysqli_query($this->conexion, $sql);

            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'UK';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombrein', descripcion = '$descripcionin'
                    WHERE id_producto = $id AND idioma = 'UK';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombrein != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'UK', '$nombrein', '$descripcionin');";
                     mysqli_query($this->conexion, $sql);
                 }
            }

            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'POR';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombrep', descripcion = '$descripcionp'
                    WHERE id_producto = $id AND idioma = 'POR';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'POR', '$nombrep', '$descripcionp');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'DEU';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombrea', descripcion = '$descripciona'
                    WHERE id_producto = $id AND idioma = 'DEU';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombrea != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'DEU', '$nombrea', '$descripciona');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'FRA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombref', descripcion = '$descripcionf'
                    WHERE id_producto = $id AND idioma = 'FRA';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombref != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'FRA', '$nombref', '$descripcionf');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'ITA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombreit', descripcion = '$descripcionit'
                    WHERE id_producto = $id AND idioma = 'ITA';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'ITA', '$nombreit', '$descripcionit');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'CAT';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombrec', descripcion = '$descripcionc'
                    WHERE id_producto = $id AND idioma = 'CAT';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'CAT', '$nombrec', '$descripcionc');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE id_producto = $id AND idioma = 'RUS';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_producto_idioma
					SET nombre = '$nombrer', descripcion = '$descripcionr'
                    WHERE id_producto = $id AND idioma = 'RUS';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_producto_idioma
                        VALUES (null, $id, 'RUS', '$nombrer', '$descripcionr');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
			
			return $query;
		}
                
                function CargarFacturas($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT f.id AS id, CONCAT(f.ano, f.id) AS numero, f.fecha AS fecha, u.nombre AS nombre, u.RazonSocial AS RazonSocial, u.id AS uid, u.dni AS nif, u.telefono AS telefono, cd.nombre AS nombreF, u.id AS uid, cd.dni AS nifF, cd.direccion AS direccion, cd.provincia AS provincia, cd.localidad AS localidad, cd.cp AS cp,
                    cd.pais AS pais, cde.nombre AS nombreE, cde.direccion AS direccionE, cde.provincia AS provinciaE, cde.localidad AS localidadE, cde.cp AS cpE, cde.pais AS paisE, cde.telefono AS telefonoE, (c.precio + c.portes) AS total, f.sesion AS sesion, f.estado AS estado, f.formapago AS formapago, 
                    p.transportista AS transportista, c.afiliado AS afiliado
					FROM bd_facturas f, bd_compra c, bd_compra_direccion cd, bd_compra_direccion_envio cde, bd_users u, bd_portes p
                    WHERE f.sesion = c.secreto
                    AND (cd.idcompra = c.id OR c.id NOT IN (SELECT idcompra FROM bd_compra_direccion))
                    AND (cde.idcompra = c.id OR c.id NOT IN (SELECT idcompra FROM bd_compra_direccion_envio))
                    AND u.id = c.idusuario
                    AND c.transportista = p.id
                    GROUP BY f.id
					ORDER BY f.fecha DESC, f.id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query)){
                                        if($assoc['formapago'] == 'domiciliacion' || $assoc['formapago'] == 'domiciliacionSubscripcion'){
                                            $sql_dom = "SELECT d.nentidad AS nentidad, d.iban, d.entidad, d.oficina, d.dc, d.ccc, d.ccc2 FROM  bd_domiciliacion AS d, bd_compra AS c WHERE d.id_compra = c.id AND c.secreto = '".$assoc['sesion']."'";
                                            $query2 = mysqli_query($this->conexion, $sql_dom);
                                            $assoc2 = mysqli_fetch_assoc($query2);
                                            array_push($assoc, $assoc2);
                                        }else if($assoc['formapago'] == 'financiacionDirecta'){
                                            $sql_dom = "SELECT d.nentidad AS nentidad, d.iban, d.entidad, d.oficina, d.dc, d.ccc, d.ccc2, fd.cuota, pc.meses FROM  bd_domiciliacion AS d, bd_compra AS c, bd_productos_fdirecta AS fd, bd_productos_cuotas AS pc WHERE d.id_compra = c.id AND fd.id_fd = c.idcuotas AND pc.id_c = fd.meses AND c.secreto = '".$assoc['sesion']."'";
                                            $query2 = mysqli_query($this->conexion, $sql_dom);
                                            $assoc2 = mysqli_fetch_assoc($query2);
                                            array_push($assoc, $assoc2);
                                        }else if($assoc['formapago'] == 'tarjeta'){
                                            $sql_dom = "SELECT t.nombre AS nombre, t.numero AS numero, t.fecha AS fecha, t.cvc AS cvc FROM  bd_tarjetas t, bd_compra c WHERE t.id_compra = c.id";
                                            $query2 = mysqli_query($this->conexion, $sql_dom);
                                            $assoc2 = mysqli_fetch_assoc($query2);
                                            array_push($assoc, $assoc2);
                                        }
                                        $resultados[] = $assoc;
                                }

			return $resultados;
		}
                
                function CargarComentarios($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
				FROM bd_comentarios 
                                ORDER BY fecha DESC
					LIMIT $limit;";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query)){
                                    switch ($assoc['tipo']){
                                        case 'Blog': $bd_disponible = 'bd_paginas';
                                            break;
                                        case 'Producto': $bd_disponible = 'bd_productos';
                                            break;
                                        case 'Galería': $bd_disponible = 'bd_categoria_galeria';
                                            break;
                                    }
                                    $sql2 = "SELECT * FROM $bd_disponible WHERE id = '".$assoc[idasociado]."'";
                                    $query2 = mysqli_query($this->conexion, $sql2);
                                    if (mysqli_num_rows($query2) > 0){
                                        $assoc2 = mysqli_fetch_assoc($query2);
                                        array_push($assoc, $assoc2['nombre']);        
                                    }
                                    $resultados[] = $assoc;
                                }

			return $resultados;
		}
                
                function CargarRMA($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT r.id AS id, r.precio AS precio, r.portes AS portes, r.fecha AS fecha, r.estado AS estado, r.comentario AS comentario, r.comentario_vend AS comentario_vend, u.nombre AS nombre, CONCAT(f.ano, f.id) AS numero
				FROM bd_rma r, bd_compra c, bd_users u, bd_facturas f
                                WHERE r.secreto = c.secreto
                                AND u.id = c.idusuario
                                AND f.sesion = r.secreto
                                ORDER BY r.fecha DESC
					LIMIT $limit;";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query)){
                                        $resultados[] = $assoc;
                                }

			return $resultados;
		}
                
                function CargarFacturaNacex($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT cde.nombre AS nombreE, cde.direccion AS direccionE, cde.provincia AS provinciaE, cde.localidad AS localidadE, 
                            cde.cp AS cpE, cde.pais AS paisE, cde.telefono AS telefonoE
                            FROM bd_facturas f, bd_compra c, bd_compra_direccion_envio cde
                            WHERE f.sesion = c.secreto
                            AND cde.idcompra = c.id
                            AND f.id = $id";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarFactura($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT p.id AS idp, p.nombre AS nombre, CONCAT(f.ano, f.id) AS numero, cp.cantidad AS cantidad,
                    cp.extra AS extra, cp.talla AS talla
					FROM bd_facturas f, bd_compra c, bd_compra_productos cp, bd_productos p
                    WHERE f.sesion = c.secreto
                    AND cp.idcompra = c.id
                    AND p.id = cp.idproducto
                    AND f.id = $id
                    AND (cp.pack = 1 OR cp.packid IS NULL)
					ORDER BY nombre ASC, idp ASC;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarExtrasPedido($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT c.* FROM bd_facturas f, bd_pedidos_extras c
                    WHERE f.sesion = c.secreto
                    AND f.id = $id
                    ORDER BY c.nombre ASC, c.id ASC;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarRMA2($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT p.id AS idp, p.nombre AS nombre, f.id AS id, cp.cantidad AS cantidad, f.fecha AS fecha,
                                cp.extra AS extra, cp.talla AS talla
                            FROM bd_rma f, bd_rma_producto cp, bd_productos p
                            WHERE cp.idrma = f.id
                            AND p.id = cp.idproducto
                            AND f.id = $id
                            AND (cp.pack = 1 OR cp.packid IS NULL OR cp.packid = '')
					ORDER BY nombre ASC, idp ASC;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function FacturaEstado($id, $estado)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$estado = mysqli_real_escape_string($this->conexion, htmlspecialchars($estado));
			
			$sql = "UPDATE bd_facturas
					SET estado = $estado
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function ComentarioEstado($id, $estado)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$estado = mysqli_real_escape_string($this->conexion, htmlspecialchars($estado));
			
			$sql = "UPDATE bd_comentarios
					SET Activo = $estado
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function RMAEstado($id, $estado, $comentario)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$estado = mysqli_real_escape_string($this->conexion, htmlspecialchars($estado));
                        $comentario = mysqli_real_escape_string($this->conexion, htmlspecialchars($comentario));
			
			$sql = "UPDATE bd_rma
					SET estado = '$estado', comentario_vend = '$comentario'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CargarContrareembolsos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT u.nombre AS nombre, u.apellidos AS apellidos, c.secreto AS secreto,
                    c.fecha AS fecha, c.precio AS precio, c.id AS id
					FROM bd_compra c, bd_users u
                    WHERE c.estado = 'contrareembolso'
                    AND c.idusuario = u.id
					ORDER BY c.fecha DESC, c.id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarTransferencias($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT u.nombre AS nombre, u.apellidos AS apellidos, c.secreto AS secreto,
                    c.fecha AS fecha, c.precio AS precio, c.id AS id
					FROM bd_compra c, bd_users u
                    WHERE c.estado = 'transferencia'
                    AND c.idusuario = u.id
					ORDER BY c.fecha DESC, c.id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarComprasPendientesDePago($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT u.nombre AS nombre, c.secreto AS secreto,
                    c.fecha AS fecha, c.precio AS precio, c.portes AS portes,c.id AS id, c.estado AS estado
					FROM bd_compra c, bd_users u
                    WHERE c.estado IN ('paypal', 'transferencia', 'contrareembolso', 'tienda', 'domiciliacion', 'domiciliacionSubscripcion', 'financiacionDirecta', 'tarjeta')
                    AND c.idusuario = u.id
					ORDER BY c.fecha DESC, c.id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarPromocionales($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT GROUP_CONCAT(id) AS ids, codigo, promocion, descuento, tipo, inicio, caducidad, min, max, COUNT(id) AS cantidad
                    FROM bd_codigos_promocional
                    GROUP BY codigo, promocion, descuento, tipo, inicio, caducidad, min, max
                    ORDER BY inicio ASC, caducidad ASC, promocion ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function NuevoPromocional($promocion, $codigo, $descuento, $tipo, $inicio, $fin, $min, $max, $cantidad)
		{
			$promocion = mysqli_real_escape_string($this->conexion, htmlspecialchars($promocion));
			$codigo = mysqli_real_escape_string($this->conexion, htmlspecialchars($codigo));
			$descuento = mysqli_real_escape_string($this->conexion, htmlspecialchars($descuento));
			$tipo = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipo));
			$inicio = mysqli_real_escape_string($this->conexion, htmlspecialchars($inicio));
			$fin = mysqli_real_escape_string($this->conexion, htmlspecialchars($fin));
			$min = mysqli_real_escape_string($this->conexion, htmlspecialchars($min));
			$max = mysqli_real_escape_string($this->conexion, htmlspecialchars($max));
			$cantidad = mysqli_real_escape_string($this->conexion, htmlspecialchars($cantidad));
            
            if ($tipo == 'p')
                $tipo = '%';
            else
                $tipo = '€';
            
            $inicio = $inicio[6].$inicio[7].$inicio[8].$inicio[9].'-'.$inicio[3].$inicio[4].'-'.$inicio[0].$inicio[1];
            $fin = $fin[6].$fin[7].$fin[8].$fin[9].'-'.$fin[3].$fin[4].'-'.$fin[0].$fin[1];
            
			$sql = "INSERT INTO bd_codigos_promocional
					VALUES (null, '$codigo', '$promocion', $descuento, '$tipo', '$inicio', '$fin', $min, $max);";
            for ($i = 0; $i < $cantidad; $i++)
                $query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function PromocionalEliminar($codigo, $tipo)
		{
			$codigo = mysqli_real_escape_string($this->conexion, htmlspecialchars($codigo));
			$tipo = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipo));
            
            if ($tipo == 'p')
                $tipo = '%';
            else
                $tipo = '€';
			
			$sql = "DELETE FROM bd_codigos_promocional
					WHERE codigo = '$codigo'
                    AND tipo = '$tipo';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CargarDescuentos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT d.*, p.nombre
					FROM bd_descuentos d, bd_productos p
                    WHERE p.id = d.idproducto
					ORDER BY cantidad ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function NuevoDescuento($producto, $cantidad, $porcentaje)
		{
            $producto = mysqli_real_escape_string($this->conexion, htmlspecialchars($producto));
			$cantidad = mysqli_real_escape_string($this->conexion, htmlspecialchars($cantidad));
			$porcentaje = mysqli_real_escape_string($this->conexion, htmlspecialchars($porcentaje));
			
			$sql = "INSERT INTO bd_descuentos
					VALUES ($producto, $cantidad, '$porcentaje');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function DescuentoEliminar($cantidad)
		{
			$cantidad = mysqli_real_escape_string($this->conexion, htmlspecialchars($cantidad));
			
			$sql = "DELETE FROM bd_descuentos
					WHERE cantidad = $cantidad;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CargarPacksProductos($idp, $limit = 10000)
		{
			$resultados = array();
			$idp = mysqli_real_escape_string($this->conexion, htmlspecialchars($idp));
			
			$sql = "SELECT pp.id AS id, GROUP_CONCAT(p.nombre SEPARATOR ', ') AS productos, GROUP_CONCAT(p.id SEPARATOR ', ') AS pids
					FROM bd_pack_productos pp, bd_productos p
                    WHERE pp.idpack = $idp
                    AND p.id IN (pp.idpro1, pp.idpro2, pp.idpro3, pp.idpro4)
                    GROUP BY pp.id
					ORDER BY pp.id ASC, p.nombre ASC, p.id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function NuevoPacksProductos($pack, $pr1, $pr2, $pr3, $pr4)
		{
			$pack = mysqli_real_escape_string($this->conexion, htmlspecialchars($pack));
			$pr1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($pr1));
			$pr2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($pr2));
			$pr3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($pr3));
			$pr4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($pr4));
            
            $pr2 = $pr2 != "" ? $pr2 : 'null';
            $pr3 = $pr3 != "" ? $pr3 : 'null';
            $pr4 = $pr4 != "" ? $pr4 : 'null';
			
			$sql = "INSERT INTO bd_pack_productos
					VALUES (null, $pack, $pr1, $pr2, $pr3, $pr4);";
			$querya = mysqli_query($this->conexion, $sql);
			$sql = "UPDATE bd_pack
					SET unidades = (SELECT COUNT(id) FROM bd_pack_productos WHERE idpack = $pack)
                    WHERE id = $pack;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $querya;
		}
		
		function PacksProductosEliminar($id, $pack)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_pack_productos
					WHERE id = $id;";
			$querya = mysqli_query($this->conexion, $sql);
			$sql = "UPDATE bd_pack
					SET unidades = (SELECT COUNT(id) FROM bd_pack_productos WHERE idpack = $pack)
                    WHERE id = $pack;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $querya;
		}
		
		function CargarPacks($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_pack
                    WHERE eliminado = 0
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarPack($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_pack
                    WHERE eliminado = 0
					AND id = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarProductos($limit = 10000)
		{
			$resultados = array();
						
			
					$sql = "SELECT DISTINCT bd_productos.*, bd_categorias.categoria FROM bd_productos LEFT JOIN bd_categorias ON bd_productos.idmarca = bd_categorias.id ORDER BY nombre ASC, id ASC LIMIT $limit;";

		/*busqueda original**/
			/*$sql = "SELECT *
					FROM bd_productos
					ORDER BY nombre ASC, id ASC
					LIMIT $limit;";*/
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarCarrito($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_carrito
					ORDER BY id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query)){
                
                    $sql = "SELECT bd_carrito.id AS idC, bd_carrito.cantidad AS cantidadC, bd_carrito.fecha AS fechaC, bd_carrito.talla AS tallaC, bd_productos.nombre AS nombreP,bd_users.nombre AS nombreU,bd_users.email AS emailU,bd_users.telefono AS telefonoU,bd_users.direccion AS direccionU FROM bd_productos,bd_users,bd_carrito WHERE bd_productos.id=$assoc[idproducto] AND bd_users.id = $assoc[idusuario] AND bd_carrito.id = $assoc[id];";
                    $query1 = mysqli_query($this->conexion, $sql);
                    $resultados[] = mysqli_fetch_assoc($query1);
                
                }
					//$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarProductosDistribuidores($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT p.*, CONCAT(d.nombre, ' ', d.apellidos) AS distribuidor, d.razonsocial AS razonsocial
					FROM bd_productos p, bd_distribuidor_producto pd, bd_distribuidores d
                    WHERE p.id = pd.id_producto
                    AND d.id = pd.id_proveedor
					ORDER BY p.nombre ASC, p.id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarProducto($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			//funcion original
			$sql = "SELECT * FROM bd_productos WHERE id = $id;";
			
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarImagenesProducto($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT null AS id, imagenprincipal
					FROM bd_productos
					WHERE id = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultados[] = $assoc;
			}
			
			$sql = "SELECT id, imagen
					FROM bd_fotos
					WHERE idproducto = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while($assoc = mysqli_fetch_assoc($query))
				$resultados[] = $assoc;
			}

			return $resultados;
		}
                
                function CargarImagenesBlog($id)
		{
			$resultados = array();
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT null AS id, imagen
					FROM  bd_paginas
					WHERE id = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultados[] = $assoc;
			}
			
			$sql = "SELECT id, imagen
					FROM bd_fotos_blog
					WHERE idblog = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				while($assoc = mysqli_fetch_assoc($query))
				$resultados[] = $assoc;
			}

			return $resultados;
		}
		
		function CargarProductosRelacionados($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT p.id AS id, p.nombre AS nombre, p2.id AS id2, p2.nombre AS nombre2
                    FROM bd_productos p, bd_productos p2, bd_productos_relacionados pr
                    WHERE p.id = pr.idproducto1
                    AND p2.id = pr.idproducto2
                    AND pr.idproducto1 <> pr.idproducto2
					ORDER BY nombre ASC, nombre2 ASC, id ASC, id2 ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarProductosAtributos($limit = 10000)
		{
			$resultados = array();
            
			$sql = "SELECT p.nombre AS producto, a.atributo AS atributo, at.atributo AS atributocat, p.id AS idp, a.id AS ida, NULL AS idad, NULL AS atributod, NULL AS atributocatd, p.precio AS precio, pa.id AS idpa
					FROM bd_productos p, bd_atributo a, bd_atributo_tipo at, bd_producto_atributo pa
                    WHERE p.id = pa.idproducto
                    AND a.id = pa.idatributo
                    AND a.tipoid = at.id
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarUsuarios($limit = 10000, $especial = '"A"')
		{
			$resultados = array();
			
			$sql = "SELECT U.*, R.rol as rol_user FROM bd_users U 
					JOIN bd_rol R ON U.rol = R.id
					ORDER BY id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarIntentos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_log_accessmail
					ORDER BY id DESC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarUsuario($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_users
					WHERE id = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
        
		function CargarDistribuidores($limit = 10000, $especial = '"A"')
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_distribuidores
                    WHERE estado IN ($especial)
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarDistribuidor($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_distribuidores
					WHERE id = $id;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function NuevoCurso($curso, $edicion, $contenido, $inicio, $fin, $color, $precio)
		{
			$curso = mysqli_real_escape_string($this->conexion, htmlspecialchars($curso));
			$edicion = mysqli_real_escape_string($this->conexion, htmlspecialchars($edicion));
			$inicio = mysqli_real_escape_string($this->conexion, htmlspecialchars($inicio));
			$fin = mysqli_real_escape_string($this->conexion, htmlspecialchars($fin));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			$color = mysqli_real_escape_string($this->conexion, htmlspecialchars($color));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
			
			$sql = "INSERT INTO bd_cursos
					VALUES (null, '$curso', '$edicion', '$contenido', STR_TO_DATE('$inicio', '%m/%d/%Y'), STR_TO_DATE('$fin', '%m/%d/%Y'), '$color', '$precio', 1);";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ModificarCurso($id, $curso, $edicion, $contenido, $inicio, $fin, $color, $precio)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$curso = mysqli_real_escape_string($this->conexion, htmlspecialchars($curso));
			$edicion = mysqli_real_escape_string($this->conexion, htmlspecialchars($edicion));
			$inicio = mysqli_real_escape_string($this->conexion, htmlspecialchars($inicio));
			$fin = mysqli_real_escape_string($this->conexion, htmlspecialchars($fin));
			$precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			$color = mysqli_real_escape_string($this->conexion, htmlspecialchars($color));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
			
			$sql = "UPDATE bd_cursos
					SET curso = '$curso', edicion = '$edicion', descripcion = '$contenido', inicio = STR_TO_DATE('$inicio', '%m/%d/%Y'), fin = STR_TO_DATE('$fin', '%m/%d/%Y'), color = '$color', precio = $precio
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NoticiaNueva($titulo, $tituloS, $descripcionS, $keyS, $contenido, $tituloin, $contenidoin, $tituloa, $contenidoa, $titulof, $contenidof, $tituloit, $contenidoit, $titulop, $contenidop, $tituloc, $contenidoc, $titulor, $contenidor, $categoria, $img)
		{
                        $nimagen = $titulo;
			$titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
                        $tituloS = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloS));
                        $descripcionS = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcionS));
                        $keyS = mysqli_real_escape_string($this->conexion, htmlspecialchars($keyS));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
            $tituloin = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloin));
			$contenidoin = mysqli_real_escape_string($this->conexion, $contenidoin);
            $tituloa = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloa));
			$contenidoa = mysqli_real_escape_string($this->conexion, $contenidoa);
            $titulof = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulof));
			$contenidof = mysqli_real_escape_string($this->conexion, $contenidof);
            $tituloit = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloit));
			$contenidoit = mysqli_real_escape_string($this->conexion, $contenidoit);
            $titulop = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulop));
			$contenidop = mysqli_real_escape_string($this->conexion, $contenidop);
            $tituloc = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloc));
			$contenidoc = mysqli_real_escape_string($this->conexion, $contenidoc);
            $titulor = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulor));
			$contenidor = mysqli_real_escape_string($this->conexion, $contenidor);
            $categoria = mysqli_real_escape_string($this->conexion, $categoria);
			
            $imgname = "";
			if ($img['error'] != 4)
			{
				$imgname = substr(strtolower(str_replace('--', '-', str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $nimagen)))), 0, 245);
                                $imgname .= "." . strtolower(end(explode(".", $img['name'])));
                                $imgname = mysqli_real_escape_string($this->conexion, htmlspecialchars($imgname));
                                //$imgname = uniqid().'_'.$img['name'];
				//move_uploaded_file($img['tmp_name'], '../imagenesproductos/'.$imgname);
                                move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = "'$imgname'";
			}
            else
                $imgname = "null";
			
			$sql = "INSERT INTO bd_paginas
					VALUES (null, '', '$titulo', '', '', '', '', '', '', '', $categoria, '$contenido', '', '', '', '', '', '', '', $imgname, 1, NOW(), 1, 0, '$tituloS', '$descripcionS', '$keyS');";
                        
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT MAX(id) AS id FROM bd_paginas WHERE noticia = 1";
            $query2 = mysqli_query($this->conexion, $sql);
            $id = mysqli_fetch_array($query2);
            
            if($tituloin != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'UK', '$tituloin', '$contenidoin');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($tituloa != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'DEU', '$tituloa', '$contenidoa');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($titulof != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'FRA', '$titulof', '$contenidof');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($tituloit != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'ITA', '$tituloit', '$contenidoit');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($titulop != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'POR', '$titulop', '$contenidop');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($tituloc != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'CAT', '$tituloc', '$contenidoc');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($titulor != null){    
                $sql = "INSERT INTO bd_blog_idioma
					VALUES (null, $id[id], 'RUS', '$titulor', '$contenidor');";
			     mysqli_query($this->conexion, $sql);
            }
            
			return $query;
		}
        
        function PaginaNueva($titulo, $contenido, $titulo_en = null, $contenido_en = null, $titulo_al = null, $contenido_al = null, $titulo_fr = null, $contenido_fr = null, $titulo_it = null, $contenido_it = null, $titulo_po = null, $contenido_po = null, $titulo_ca = null, $contenido_ca = null, $titulo_ru = null, $contenido_ru = null, $img)
		{
			$titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
                        $titulo_en = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_en));
			$contenido_en = mysqli_real_escape_string($this->conexion, $contenido_en);
                        $titulo_al = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_al));
			$contenido_al = mysqli_real_escape_string($this->conexion, $contenido_al);
                        $titulo_fr = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_fr));
			$contenido_fr = mysqli_real_escape_string($this->conexion, $contenido_fr);
                        $titulo_it = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_it));
			$contenido_it = mysqli_real_escape_string($this->conexion, $contenido_it);
                        $titulo_po = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_po));
			$contenido_po = mysqli_real_escape_string($this->conexion, $contenido_po);
                        $titulo_ca = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ca));
			$contenido_ca = mysqli_real_escape_string($this->conexion, $contenido_ca);
                        $titulo_ru = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ru));
			$contenido_ru = mysqli_real_escape_string($this->conexion, $contenido_ru);
			
            $imgname = "''";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = "'$imgname'";
			}
			
			$sql = "INSERT INTO bd_paginas VALUES
					(null, '', '$titulo', '$titulo_en', '$titulo_al', '$titulo_fr', '$titulo_it', '$titulo_po', '$titulo_ca', '$titulo_ru', 0, '$contenido', '$contenido_en', '$contenido_al', '$contenido_fr', '$contenido_it', '$contenido_po', '$contenido_ca', '$contenido_ru', $imgname, 0, NOW(), 1, 0, '', '', '', 0);";
			$query = mysqli_query($this->conexion, $sql);
                        			
			return $query;
		}
                   
    function EnlaceNuevo($url, $titulo, $pagaso, $contenido, $titulo_en = null, $contenido_en = null, $titulo_al = null, $contenido_al = null, $titulo_fr = null, $contenido_fr = null, $titulo_it = null, $contenido_it = null, $titulo_po = null, $contenido_po = null, $titulo_ca = null, $contenido_ca = null, $titulo_ru = null, $contenido_ru = null, $img)
		{
			$url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
                        $titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
                        $pagaso = mysqli_real_escape_string($this->conexion, htmlspecialchars($pagaso));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
                        $titulo_en = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_en));
			$contenido_en = mysqli_real_escape_string($this->conexion, $contenido_en);
                        $titulo_al = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_al));
			$contenido_al = mysqli_real_escape_string($this->conexion, $contenido_al);
                        $titulo_fr = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_fr));
			$contenido_fr = mysqli_real_escape_string($this->conexion, $contenido_fr);
                        $titulo_it = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_it));
			$contenido_it = mysqli_real_escape_string($this->conexion, $contenido_it);
                        $titulo_po = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_po));
			$contenido_po = mysqli_real_escape_string($this->conexion, $contenido_po);
                        $titulo_ca = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ca));
			$contenido_ca = mysqli_real_escape_string($this->conexion, $contenido_ca);
                        $titulo_ru = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ru));
			$contenido_ru = mysqli_real_escape_string($this->conexion, $contenido_ru);
			
            $imgname = "";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = "'$imgname'";
			}
			
			$sql = "INSERT INTO bd_paginas VALUES
					(null, '$url', '$titulo', '$titulo_en', '$titulo_al', '$titulo_fr', '$titulo_it', '$titulo_po', '$titulo_ca', '$titulo_ru', 0, '$contenido', '$contenido_en', '$contenido_al', '$contenido_fr', '$contenido_it', '$contenido_po', '$contenido_ca', '$contenido_ru', $imgname, 2, NOW(), 1, '$pagaso', '', '', '');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                		
		function PaginaModificar($id, $titulo, $url, $destino, $contenido, $titulo_en = null, $contenido_en = null, $titulo_al = null, $contenido_al = null, $titulo_fr = null, $contenido_fr = null,
                         $titulo_it = null, $contenido_it = null, $titulo_po = null, $contenido_po = null, $titulo_ca = null, $contenido_ca = null, $titulo_ru = null, $contenido_ru = null, $img)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
                        $titulo_en = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_en));
			$contenido_en = mysqli_real_escape_string($this->conexion, $contenido_en);
                        $titulo_al = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_al));
			$contenido_al = mysqli_real_escape_string($this->conexion, $contenido_al);
                        $titulo_fr = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_fr));
			$contenido_fr = mysqli_real_escape_string($this->conexion, $contenido_fr);
                        $titulo_it = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_it));
			$contenido_it = mysqli_real_escape_string($this->conexion, $contenido_it);
                        $titulo_po = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_po));
			$contenido_po = mysqli_real_escape_string($this->conexion, $contenido_po);
                        $titulo_ca = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ca));
			$contenido_ca = mysqli_real_escape_string($this->conexion, $contenido_ca);
                        $titulo_ru = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ru));
			$contenido_ru = mysqli_real_escape_string($this->conexion, $contenido_ru);
                        $url = mysqli_real_escape_string($this->conexion, $url);;
                        $destino = mysqli_real_escape_string($this->conexion, $destino);;
			
            $imgname = "";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}
			
			$sql = "UPDATE bd_paginas
					SET url = '$url', destino = '$destino', nombre = '$titulo', contenido = '$contenido', nombre_en = '$titulo_en', contenido_en = '$contenido_en', nombre_al = '$titulo_al', contenido_al = '$contenido_al', nombre_fr = '$titulo_fr', contenido_fr = '$contenido_fr', nombre_it = '$titulo_it', contenido_it = '$contenido_it', nombre_po = '$titulo_po', contenido_po = '$contenido_po', nombre_ca = '$titulo_ca', contenido_ca = '$contenido_ca', nombre_ru = '$titulo_ru', contenido_ru = '$contenido_ru', fecha = NOW()$imgname
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function DesactivarPagina($id){
                    $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                    
                    $sql = "UPDATE bd_paginas
					SET visible = '0'
					WHERE id = $id;";
                    $query = mysqli_query($this->conexion, $sql);
			
                    return $query;
                }
                
                function ActivarPagina($id){
                    $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                    
                    $sql = "UPDATE bd_paginas
					SET visible = '1'
					WHERE id = $id;";
                    $query = mysqli_query($this->conexion, $sql);
			
                    return $query;
                    
                }
                
                function DesactivarGE(){
                    $sql = "UPDATE bd_empresa
					SET desactivarGE = '0'
					WHERE id = 1";
                    $query = mysqli_query($this->conexion, $sql);
			
                    return $query;
                    
                }
                
                function ActivarGE(){
                    $sql = "UPDATE bd_empresa
					SET desactivarGE = '1'
					WHERE id = 1";
                    $query = mysqli_query($this->conexion, $sql);
			
                    return $query;
                    
                }
                
                function EnlaceModificar($id, $url, $titulo, $pagaso, $contenido, $titulo_en = null, $contenido_en = null, $titulo_al = null, $contenido_al = null, $titulo_fr = null, $contenido_fr = null,
                         $titulo_it = null, $contenido_it = null, $titulo_po = null, $contenido_po = null, $titulo_ca = null, $contenido_ca = null, $titulo_ru = null, $contenido_ru = null, $img)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                        $url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
			$titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
                        $pagaso = mysqli_real_escape_string($this->conexion, htmlspecialchars($pagaso));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
                        $titulo_en = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_en));
			$contenido_en = mysqli_real_escape_string($this->conexion, $contenido_en);
                        $titulo_al = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_al));
			$contenido_al = mysqli_real_escape_string($this->conexion, $contenido_al);
                        $titulo_fr = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_fr));
			$contenido_fr = mysqli_real_escape_string($this->conexion, $contenido_fr);
                        $titulo_it = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_it));
			$contenido_it = mysqli_real_escape_string($this->conexion, $contenido_it);
                        $titulo_po = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_po));
			$contenido_po = mysqli_real_escape_string($this->conexion, $contenido_po);
                        $titulo_ca = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ca));
			$contenido_ca = mysqli_real_escape_string($this->conexion, $contenido_ca);
                        $titulo_ru = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo_ru));
			$contenido_ru = mysqli_real_escape_string($this->conexion, $contenido_ru);
			
            $imgname = "";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}
			
			$sql = "UPDATE bd_paginas
					SET url = '$url', nombre = '$titulo', categoria_pag = '$pagaso', contenido = '$contenido', nombre_en = '$titulo_en', contenido_en = '$contenido_en', nombre_al = '$titulo_al', contenido_al = '$contenido_al', nombre_fr = '$titulo_fr', contenido_fr = '$contenido_fr', nombre_it = '$titulo_it', contenido_it = '$contenido_it', nombre_po = '$titulo_po', contenido_po = '$contenido_po', nombre_ca = '$titulo_ca', contenido_ca = '$contenido_ca', nombre_ru = '$titulo_ru', contenido_ru = '$contenido_ru', fecha = NOW()$imgname
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function NoticiaModificar($id, $titulo, $tituloS, $descripcionS, $keyS, $contenido, $tituloin, $contenidoin, $tituloa, $contenidoa, $titulof, $contenidof, $tituloit, $contenidoit, $titulop, $contenidop, $tituloc, $contenidoc, $titulor, $contenidor, $categoria, $img)
		{
                        $nimagen = $titulo;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$titulo = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulo));
                        $tituloS = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloS));
                        $descripcionS = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcionS));
                        $keyS = mysqli_real_escape_string($this->conexion, htmlspecialchars($keyS));
			$contenido = mysqli_real_escape_string($this->conexion, $contenido);
            $tituloin = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloin));
			$contenidoin = mysqli_real_escape_string($this->conexion, $contenidoin);
            $tituloa = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloa));
			$contenidoa = mysqli_real_escape_string($this->conexion, $contenidoa);
            $titulof = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulof));
			$contenidof = mysqli_real_escape_string($this->conexion, $contenidof);
            $tituloit = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloit));
			$contenidoit = mysqli_real_escape_string($this->conexion, $contenidoit);
            $titulop = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulop));
			$contenidop = mysqli_real_escape_string($this->conexion, $contenidop);
            $tituloc = mysqli_real_escape_string($this->conexion, htmlspecialchars($tituloc));
			$contenidoc = mysqli_real_escape_string($this->conexion, $contenidoc);
            $titulor = mysqli_real_escape_string($this->conexion, htmlspecialchars($titulor));
			$contenidor = mysqli_real_escape_string($this->conexion, $contenidor);
            $categoria = mysqli_real_escape_string($this->conexion, $categoria);
			
            $imgname = "";
			if ($img['error'] != 4)
			{
                                $imgname = strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $nimagen)));
                                $imgname .= "." . strtolower(end(explode(".", $img['name'])));
                                $imgname = mysqli_real_escape_string($this->conexion, htmlspecialchars($imgname));
				//$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenes/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}
			
			$sql = "UPDATE bd_paginas
					SET nombre = '$titulo', tituloS = '$tituloS', descripcionS = '$descripcionS', `keyS` = '$keyS', idcat = $categoria, contenido = '$contenido'$imgname
					WHERE id = $id AND noticia = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'UK';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$tituloin', descripcion = '$contenidoin'
                    WHERE idblog = $id AND idioma = 'UK';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($tituloin != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'UK', '$tituloin', '$contenidoin');";
                     mysqli_query($this->conexion, $sql);
                 }
            }

            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'POR';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$titulop', descripcion = '$contenidop'
                    WHERE idblog = $id AND idioma = 'POR';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($titulop != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'POR', '$titulop', '$contenidop');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'DEU';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$tituloa', descripcion = '$contenidoa'
                    WHERE idblog = $id AND idioma = 'DEU';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($tituloa != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'DEU', '$tituloa', '$contenidoa');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_producto_idioma
                    WHERE idblog = $id AND idioma = 'FRA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$titulof', descripcion = '$contenidof'
                    WHERE idblog = $id AND idioma = 'FRA';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($titulof != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'FRA', '$titulof', '$contenidof');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'ITA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$tituloit', descripcion = '$contenidoit'
                    WHERE idblog = $id AND idioma = 'ITA';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($tituloit != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'ITA', '$tituloit', '$contenidoit');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'CAT';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$tituloc', descripcion = '$contenidoc'
                    WHERE idblog = $id AND idioma = 'CAT';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($tituloit != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'CAT', '$tituloc', '$contenidoc');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
            $sql = "SELECT * FROM bd_blog_idioma
                    WHERE idblog = $id AND idioma = 'RUS';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_blog_idioma
					SET nombre = '$titulor', descripcion = '$contenidor'
                    WHERE idblog = $id AND idioma = 'RUS';";
			     mysqli_query($this->conexion, $sql);
            }else{
                if($tituloit != null){
                    $sql = "INSERT INTO bd_blog_idioma
                        VALUES (null, $id, 'RUS', '$titulor', '$contenidor');";
                     mysqli_query($this->conexion, $sql);
                 }
            }
            
			return $query;
		}
		
		function CargarPaginas($limit = 10000, $orden = 'id DESC', $especial = 1)
		{
			$resultados = array();
			
			$sql = "SELECT *, nombre AS titulo
					FROM bd_paginas
                    WHERE noticia = 0 OR noticia = 2
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarPaginas2($limit = 10000, $orden = 'id DESC', $especial = 1)
		{
			$resultados = array();
			
			$sql = "SELECT *, nombre AS titulo
					FROM bd_paginas
                    WHERE noticia = 0 AND id <> 20001 AND id <> 20002 AND id <> 20012 AND id <> 20013 AND id <> 20016
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarPagina($id = 1)
		{
			$resultado = null;
			
			$sql = "SELECT *, nombre AS titulo, nombre_en AS titulo_en, nombre_al AS titulo_al, nombre_fr AS titulo_fr, nombre_it AS titulo_it, nombre_po AS titulo_po, nombre_ca AS titulo_ca, nombre_ru AS titulo_ru
					FROM bd_paginas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
                function CargarEnlace($id = 1)
		{
			$resultado = null;
			
			$sql = "SELECT *, url AS url, nombre AS titulo, nombre_en AS titulo_en, nombre_al AS titulo_al, nombre_fr AS titulo_fr, nombre_it AS titulo_it, nombre_po AS titulo_po, nombre_ca AS titulo_ca, nombre_ru AS titulo_ru
					FROM bd_paginas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarNoticias($limit = 10000, $orden = 'id DESC')
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_paginas
                    WHERE noticia = 1
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarNoticiasFeed($limit = 10000, $orden = 'id DESC')
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_paginas
                    WHERE noticia = 1
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarNoticiasCat()
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categoria_blog;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarGaleriasCat()
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categoria_galeria;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarNoticia($id = 1)
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_paginas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarProvincias($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT ID, Name
					FROM bd_city
					WHERE CountryCode IN ('ESP', 'ESX')
					ORDER BY Name ASC, ID ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarProvincias2($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT ID, Name
					FROM bd_city
					WHERE CountryCode IN (SELECT code FROM `bd_paises` WHERE activo = 1)
					ORDER BY CountryCode ASC, Name ASC, ID ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarATransp($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_transportista
					ORDER BY nombre ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarATranspP($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_transportista_peso
					ORDER BY nombre ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarPaises($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT Code, Name
					FROM bd_paises
					WHERE activo = 1
					ORDER BY Name ASC, Code ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarPortes($limit = 10000)
		{
			$resultados = array();
			
			/*$sql = "SELECT bd_portes.region AS region, precio, max, Code, Name
					FROM bd_portes, bd_paises
					WHERE Code = bd_portes.region
					AND activo = 1
					ORDER BY Name ASC, precio ASC
					LIMIT $limit;";*/
                        $sql = "SELECT * FROM bd_portes ORDER BY transportista ASC";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarPortesKm($limit = 10000)
		{
			$resultados = array();
			
			
                        $sql = "SELECT * FROM bd_portes_km ORDER BY hastakm ASC";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarPortesProvincias($limit = 10000)
		{
			$resultados = array();
			
			
                        $sql = "SELECT p.id AS idp, p.precio AS precio, t.nombre AS nombre, c.Name AS name, c.ID AS idc, t.id AS idt
                                FROM bd_portes_provincias p, bd_transportista t, bd_city c 
                                WHERE p.id_transp = t.id AND p.id_provincia = c.id";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['idc']][$assoc['idt']] = $assoc;

			return $resultados;
		}
                
                function CargarPortesProvinciasDefecto($limit = 10000)
		{
			$resultados = array();
			
			
                        $sql = "SELECT p.id AS idp, p.precio AS precio, t.nombre AS nombre, t.id AS idt
                                FROM bd_portes_provincias p, bd_transportista t
                                WHERE p.id_transp = t.id AND p.id_provincia = 0";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['idt']] = $assoc;

			return $resultados;
		}
                
                function CargarPortesI($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT p.precio AS precio, t.nombre AS nombre
					FROM bd_portes_provincias p, bd_transportista t
					WHERE id_transp = $id AND id_provincia = 0 AND t.id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
                function CargarPortesProvinciasPeso($limit = 10000)
		{
			$resultados = array();
			
			
                        $sql = "SELECT p.id AS idp, p.precio AS precio, t.nombre AS nombre, c.Name AS name, c.ID AS idc, t.id AS idt
                                FROM bd_portes_provincias_peso p, bd_transportista_peso t, bd_city c 
                                WHERE p.id_transp = t.id AND p.id_provincia = c.id";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['idc']][$assoc['idt']] = $assoc;

			return $resultados;
		}
                
                function CargarPortesProvinciasPesoDefecto($limit = 10000)
		{
			$resultados = array();
			
			
                        $sql = "SELECT p.id AS idp, p.precio AS precio, t.nombre AS nombre, t.id AS idt
                                FROM bd_portes_provincias_peso p, bd_transportista_peso t
                                WHERE p.id_transp = t.id AND p.id_provincia = 0";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['idt']] = $assoc;

			return $resultados;
		}
                
                function CargarPortesIP($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT p.precio AS precio, t.nombre AS nombre
					FROM bd_portes_provincias_peso p, bd_transportista_peso t
					WHERE id_transp = $id AND id_provincia = 0 AND t.id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
                function ModificarPorteProvinciaD($id, $precio){
                        $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                        $precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			
			$sql = "UPDATE bd_portes_provincias
				SET precio = '$precio'
                                WHERE id_transp = $id AND id_provincia = 0;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
                }
                
                function ModificarPorteProvinciaDP($id, $precio){
                        $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                        $precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
			
			$sql = "UPDATE bd_portes_provincias_peso
				SET precio = '$precio'
                                WHERE id_transp = $id AND id_provincia = 0;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
                }
		
		function CargarSliders($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT s.*, c.nombre 
                    FROM bd_slider s, bd_menu c 
                    WHERE c.id = s.idcat 
                    ORDER BY orden ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarImagenesCat($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT i.*, m.nombre 
                    FROM bd_imagen_categoria i, bd_menu m
                    WHERE m.id = i.idcat 
                    ORDER BY i.id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarSlidersInicio($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT s.*
                    FROM bd_slider s
                    WHERE s.idcat = 0
                    ORDER BY orden ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarSlider($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT id, nombre, id_padre
					FROM bd_slider
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarCursos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_cursos
					ORDER BY inicio ASC, fin ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarCurso($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_cursos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarCategoriasBlog($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categoria_blog
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarCategoriasGaleria($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categoria_galeria
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarCategoriasAtribuos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_atributo_tipo
					ORDER BY atributo ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarCategoriaAtribuos($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_atributo_tipo
					WHERE id = $id
					ORDER BY atributo ASC, id ASC;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarAtributos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT a.id AS id, a.atributo AS atributo, at.atributo AS atributocat
					FROM bd_atributo a, bd_atributo_tipo at
					WHERE a.tipoid = at.id
					ORDER BY atributocat ASC, atributo ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarAtributosDependencia($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT a.id AS id, a.atributo AS atributo, at.atributo AS atributocat
					FROM bd_atributo a, bd_atributo_tipo at
					WHERE a.tipoid = at.id
					ORDER BY atributocat ASC, atributo ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarAtributo($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_atributo
					WHERE id = $id
					ORDER BY atributo ASC, id ASC;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarMenus($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT m1.id AS id, m1.nombre AS nombre, m1.orden AS orden, m1.categoria AS categoria, m2.nombre AS padre
					FROM bd_menu m1, bd_menu m2
					WHERE m1.id_padre = m2.id
                    UNION
                    SELECT id AS id, nombre AS nombre, orden AS orden, categoria AS categoria, '-' AS padre
					FROM bd_menu
					WHERE id_padre IS null
					ORDER BY id ASC, orden ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarMenusCat($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_menu
					ORDER BY id ASC, orden ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarMenu($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT id, nombre, url, id_padre, categoria, descripcion, imagen
					FROM bd_menu
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function CargarConfiguracion()
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_empresa;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                function CargarNacex()
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_nacex;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
        
        function CargarPlantillas()
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_configuracion
                    WHERE id = 1;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
        function CargaPosibilidades($tipo)
                {
                    $resultados = array();
			
			$sql = "SELECT * FROM bd_temas WHERE tipo = '$tipo';";
                        $query = mysqli_query($this->conexion, $sql);

                        if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                        
			return $resultados;
                }
                
                function CargarFuentes()
		{
			$resultado = null;
			
			$sql = "SELECT * FROM bd_fuentes;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
                
                function CargarMensaje()
		{
			$resultado = null;
			
			$sql = "SELECT actanu, enlvid, anchvid, luganu FROM bd_empresa WHERE id = 1;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
        
                function CargarColores()
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_colores;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
                
                function CargarColores2()
		{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_colores_productos;";
					
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
		}
		
		function PaisEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_paises
					SET activo = ABS(activo - 1)
					WHERE Code = '$id';";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function DistribuidorEstado($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_distribuidores
					SET estado = 'A'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CargarTodosLosPaises($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT Code, Name, Continent, activo
					FROM bd_paises
					ORDER BY activo DESC, Name ASC, Code ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarCategorias($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
		function CargarSCategorias($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
                                        WHERE marca = 0
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function CargarSCategorias2($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
                                        WHERE marca = 0
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[$assoc['id']] = $assoc['categoria'];

			return $resultados;
		}
                
        function CargarCategoriasPadre($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
                                        WHERE marca = 0 AND idpadre IS NULL
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function CargarCategoriasHijos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
                                        WHERE marca = 0 AND idpadre IS NOT NULL
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function CargarMasVendidos($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT mv.id, p.nombre
					FROM bd_mas_vendidos mv, bd_productos p
                                        WHERE mv.id_producto = p.id
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarNovedades($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT mv.id, p.nombre
					FROM bd_novedades mv, bd_productos p
                                        WHERE mv.id_producto = p.id
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarMarcas($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_categorias
                                        WHERE marca = 1
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
                function CargarFichProd($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT pf.id as id, pf.idproducto AS idproducto, pf.fichero AS fichero, pf.nombre AS nombre, p.nombre AS pnombre
					FROM bd_productos_ficheros pf, bd_productos p
                                        WHERE p.id = pf.idproducto
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarCategoriasImg($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_menu
                    WHERE id NOT IN (SELECT idcat FROM bd_imagen_categoria) AND id_padre IS NULL
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CargarCategoria($id)
		{
			$resultado =null;
			
			$sql = "SELECT *
					FROM bd_categorias
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado = $assoc;

			return $resultado;
		}
        
        function CargarCategoriaBlog($id)
		{
			$resultado =null;
			
			$sql = "SELECT *
					FROM bd_categoria_blog
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado = $assoc;

			return $resultado;
		}
        
        function CargarCategoriaGaleria($id)
		{
			$resultado =null;
			
			$sql = "SELECT *
					FROM bd_categoria_galeria
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado = $assoc;

			return $resultado;
		}
		//Cargar las relaciones de categorías con las de GoogleMerchant
		function CargarCategoriasMerchant($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_cats_merchant
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultado;
		}
		//Cargar los tipos de envíos disponiles para Google Merchant
		function CargarEnviosMerchant($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_envios_merchant
					ORDER BY id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultado;
		}
		function CargarCategoriasAmpliados($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT c.id AS id, c.idpadre AS idpadre, c.categoria AS categoria, c2.id AS idp, c2.categoria AS categoriap
					FROM bd_categorias c, bd_categorias c2
                    WHERE c.idpadre = c2.id
                    UNION
                    SELECT c.id AS id, c.idpadre AS idpadre, c.categoria AS categoria, NULL AS idp, NULL AS categoriap
					FROM bd_categorias c
                    WHERE c.idpadre IS NULL
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function CargarCategoriasAmpliados2($limit = 10000, $tipo = 0)
		{
			$resultados = array();
			
			$sql = "SELECT c.id AS id, c.idpadre AS idpadre, c.categoria AS categoria, c.orden AS orden, c2.id AS idp, c2.categoria AS categoriap, c.extension
					FROM bd_categorias c, bd_categorias c2
                    WHERE c.idpadre = c2.id AND c.marca = $tipo
                    UNION
                    SELECT c.id AS id, c.idpadre AS idpadre, c.categoria AS categoria,  c.orden AS orden, NULL AS idp, NULL AS categoriap, c.extension
					FROM bd_categorias c
                    WHERE c.idpadre IS NULL AND c.marca = $tipo
					ORDER BY categoria ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
		
		function CategoriaNueva($nombre, $padre = null, $menu)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        $menu = mysqli_real_escape_string($this->conexion, htmlspecialchars($menu));
			if (@$padre == null || @$padre == '') $padre = 'null';
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
			
			$sql = "INSERT INTO bd_categorias
					VALUES (null, '$nombre', '', $padre, '', 0, $menu, 0, '');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function MasVendidoNuevo($producto)
		{
			$producto = mysqli_real_escape_string($this->conexion, htmlspecialchars($producto));
                        			
			$sql = "INSERT INTO bd_mas_vendidos
					VALUES (null, '$producto');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function NovedadesNuevo($producto)
		{
			$producto = mysqli_real_escape_string($this->conexion, htmlspecialchars($producto));
                        			
			$sql = "INSERT INTO bd_novedades
					VALUES (null, '$producto');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function MasVendidoOpciones($activo, $modo, $posicion, $texto)
		{
			$activo = mysqli_real_escape_string($this->conexion, htmlspecialchars($activo));
                        $modo = mysqli_real_escape_string($this->conexion, htmlspecialchars($modo));
                        $texto = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto));
                        $posicion = mysqli_real_escape_string($this->conexion, htmlspecialchars($posicion));
                        			
			$sql = "UPDATE bd_empresa
                        SET masvendido = '$activo', mvmodo = '$modo', textomv = '$texto', mvposicion = '$posicion' WHERE id = 1";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                 function NovedadesOpciones($activo, $modo, $posicion, $texto)
		{
			$activo = mysqli_real_escape_string($this->conexion, htmlspecialchars($activo));
                        $modo = mysqli_real_escape_string($this->conexion, htmlspecialchars($modo));
                        $texto = mysqli_real_escape_string($this->conexion, htmlspecialchars($texto));
                        $posicion = mysqli_real_escape_string($this->conexion, htmlspecialchars($posicion));
                        			
			$sql = "UPDATE bd_empresa
                        SET novedades = '$activo', novmodo = '$modo', textonov = '$texto', novposicion = '$posicion' WHERE id = 1";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function MarcaNueva($nombre, $padre = null, $menu, $ext = '')
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $menu = mysqli_real_escape_string($this->conexion, htmlspecialchars($menu));
			if (@$padre == null || @$padre == '') $padre = 'null';
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
			
			$sql = "INSERT INTO bd_categorias
					VALUES (null, '$nombre', '', $padre, '', 0, $menu, 1, '$ext');";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			return mysqli_insert_id($this->conexion);
		}
                
                function FicheroNuevo($producto, $nombre, $fichero = '')
		{
			$producto = mysqli_real_escape_string($this->conexion, htmlspecialchars($producto));    
                        $nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre)); 
			
			$sql = "INSERT INTO bd_productos_ficheros
					VALUES (null, '$producto', '$fichero', '$nombre');";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			return mysqli_insert_id($this->conexion);
		}
        
        function CategoriaNuevaBlog($nombre, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer)
	{
            $nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
            $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
            $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
            $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
            $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
            $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
            $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			
			$sql = "INSERT INTO bd_categoria_blog
					VALUES (null, '$nombre');";
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT MAX(id) AS id FROM bd_categoria_blog";
            $query2 = mysqli_query($this->conexion, $sql);
            $id = mysqli_fetch_array($query2);
            
            if($nombrein != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'UK', '$nombrein');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrea != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'DEU', '$nombrea');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombref != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'FRA', '$nombref');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombreit != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'ITA', '$nombreit');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrep != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'POR', '$nombrep');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrec != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'CAT', '$nombrec');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrer != null){    
                $sql = "INSERT INTO bd_catblog_idioma
					VALUES (null, $id[id], 'RUS', '$nombrer');";
			     mysqli_query($this->conexion, $sql);
            }
            
			return $query;
		}
        
        function CategoriaNuevaGaleria($nombre, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
            $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
            $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
            $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
            $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
            $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
            $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
            
			$sql = "INSERT INTO bd_categoria_galeria
					VALUES (null, '$nombre');";
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT MAX(id) AS id FROM bd_categoria_galeria";
            $query2 = mysqli_query($this->conexion, $sql);
            $id = mysqli_fetch_array($query2);
            
            if($nombrein != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'UK', '$nombrein');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrea != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'DEU', '$nombrea');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombref != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'FRA', '$nombref');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombreit != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'ITA', '$nombreit');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrep != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'POR', '$nombrep');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrec != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'CAT', '$nombrec');";
			     mysqli_query($this->conexion, $sql);
            }
            
            if($nombrer != null){    
                $sql = "INSERT INTO bd_catgaleria_idioma
					VALUES (null, $id[id], 'RUS', '$nombrer');";
			     mysqli_query($this->conexion, $sql);
            }
            
			return $query;
		}
		
		function ModificarCategoria($id, $nombre, $padre, $menu, $ext = '')
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $menu = mysqli_real_escape_string($this->conexion, htmlspecialchars($menu));
			if (@$padre == null || @$padre == '') $padre = 'null';
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
			
			$sql = "UPDATE bd_categorias
					SET categoria = '$nombre', idpadre = $padre, idmenu = $menu, extension = '$ext'
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ModificarCategoriaBlog($id, $nombre, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
            $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
            $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
            $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
            $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
            $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
            $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			
			$sql = "UPDATE bd_categoria_blog
					SET nombre = '$nombre'
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'UK';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombrein'
                        WHERE idcatblog = $id AND idioma = 'UK';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrein != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'UK', '$nombrein');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'DEU';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombrea'
                        WHERE idcatblog = $id AND idioma = 'DEU';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrea != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'DEU', '$nombrea');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'FRA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombref'
                        WHERE idcatblog = $id AND idioma = 'FRA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombref != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'FRA', '$nombref');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'ITA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombreit'
                        WHERE idcatblog = $id AND idioma = 'ITA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'ITA', '$nombreit');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'POR';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombrep'
                        WHERE idcatblog = $id AND idioma = 'POR';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'POR', '$nombrep');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'CAT';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombrec'
                        WHERE idcatblog = $id AND idioma = 'CAT';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'CAT', '$nombrec');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catblog_idioma
                    WHERE idcatblog = $id AND idioma = 'RUS';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catblog_idioma
                        SET nombre = '$nombrer'
                        WHERE idcatblog = $id AND idioma = 'RUS';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catblog_idioma
                            VALUES (null, $id, 'RUS', '$nombrer');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
			return $query;
		}
        
        function ModificarCategoriaGaleria($id, $nombre, $nombrein, $nombrea, $nombref, $nombreit, $nombrep, $nombrec, $nombrer)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $nombrein = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrein));
            $nombrea = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrea));
            $nombref = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombref));
            $nombreit = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreit));
            $nombrep = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrep));
            $nombrec = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrec));
            $nombrer = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombrer));
			
			$sql = "UPDATE bd_categoria_galeria
					SET nombre = '$nombre'
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'UK';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombrein'
                        WHERE idcatgaleria = $id AND idioma = 'UK';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrein != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'UK', '$nombrein');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'DEU';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombrea'
                        WHERE idcatgaleria = $id AND idioma = 'DEU';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrea != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'DEU', '$nombrea');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'FRA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombref'
                        WHERE idcatgaleria = $id AND idioma = 'FRA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombref != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'FRA', '$nombref');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'ITA';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombreit'
                        WHERE idcatgaleria = $id AND idioma = 'ITA';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombreit != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'ITA', '$nombreit');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'POR';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombrep'
                        WHERE idcatgaleria = $id AND idioma = 'POR';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'POR', '$nombrep');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'CAT';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombrec'
                        WHERE idcatgaleria = $id AND idioma = 'CAT';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'CAT', '$nombrec');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            $sql = "SELECT * FROM bd_catgaleria_idioma
                    WHERE idcatgaleria = $id AND idioma = 'RUS';";
			$res = mysqli_query($this->conexion, $sql);
            
            if(mysqli_num_rows($res) == 1){
                $sql = "UPDATE bd_catgaleria_idioma
                        SET nombre = '$nombrer'
                        WHERE idcatgaleria = $id AND idioma = 'RUS';";
                mysqli_query($this->conexion, $sql);
            }else{
                if($nombrep != null){
                    $sql = "INSERT INTO bd_catgaleria_idioma
                            VALUES (null, $id, 'RUS', '$nombrer');";
                    mysqli_query($this->conexion, $sql);
                }
            }
            
            return $query;
		}
        
        function ActivarUsuario($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
            
            $sql = "SELECT activo FROM bd_users WHERE id = $id;";
            $query = mysqli_query($dbi, $sql);
            $activo = mysqli_fetch_array($query);
            if($activo[activo] == 'A')
              $reg = C;
            else
              $reg = A;
			
			$sql = "UPDATE bd_users
					SET activo = '$reg'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function CategoriaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_categorias
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function FicheroEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_productos_ficheros
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function MasVendidoEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_mas_vendidos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function NovedadesEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_novedades
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function CategoriaGaleriaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_categoria_galeria
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function CategoriaBlogEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_categoria_blog
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function MetodosModificar($cuenta, $bic, $paypal, $ippaypal, $ifpaypal, $ccr, $pagotienda, $iban, $url, $fuc, $ter, $mon, $kc, $aplazamePuK, $aplazamePrK)
		{
			$cuenta = mysqli_real_escape_string($this->conexion, htmlspecialchars($cuenta));
            $paypal = mysqli_real_escape_string($this->conexion, htmlspecialchars($paypal));
            $ippaypal = mysqli_real_escape_string($this->conexion, htmlspecialchars($ippaypal));
            $ifpaypal = mysqli_real_escape_string($this->conexion, htmlspecialchars($ifpaypal));
            $ccr = mysqli_real_escape_string($this->conexion, htmlspecialchars($ccr));
            $pagotienda = mysqli_real_escape_string($this->conexion, htmlspecialchars($pagotienda));
            $iban = mysqli_real_escape_string($this->conexion, htmlspecialchars($iban));
            $url = mysqli_real_escape_string($this->conexion, htmlspecialchars($url));
            $fuc = mysqli_real_escape_string($this->conexion, htmlspecialchars($fuc));
            $ter = mysqli_real_escape_string($this->conexion, htmlspecialchars($ter));
            $mon = mysqli_real_escape_string($this->conexion, htmlspecialchars($mon));
            $kc = mysqli_real_escape_string($this->conexion, htmlspecialchars($kc));
            $aplazamePuK = mysqli_real_escape_string($this->conexion, htmlspecialchars($aplazamePuK));
            $aplazamePrK = mysqli_real_escape_string($this->conexion, htmlspecialchars($aplazamePrK));
            
            if($url != '')
                $tpv = 1;
            else
                $tpv = 0;
            
            if($ccr == null || $ccr == '')
                $ccr = 0;
            
            $sql = "UPDATE bd_empresa
					SET cuenta = '$cuenta', bicswift = '$bic', paypal = '$paypal', ippaypal = '$ippaypal', ifpaypal = '$ifpaypal', tasacontrareembolso = $ccr, entienda = $pagotienda, iban = '$iban',
                                            tpv = '$tpv', url = '$url', fuc = '$fuc', ter = '$ter', mon_tpv = '$mon', kc = '$kc', aplazamePuK = '$aplazamePuK', aplazamePrK = '$aplazamePrK'
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function PeticionTPV(){
            $sql = "UPDATE bd_empresa
					SET tpv = 1
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
        }
        
        function PlantillaModificar($inicio, $efecto, $CFefecto, $CLefecto, $productos, $producto, $cabecera, $pie, $imagen)
	{
            $inicio = mysqli_real_escape_string($this->conexion, htmlspecialchars($inicio));
            $efecto = mysqli_real_escape_string($this->conexion, htmlspecialchars($efecto));
            $CFefecto = mysqli_real_escape_string($this->conexion, htmlspecialchars($CFefecto));
            $CLefecto = mysqli_real_escape_string($this->conexion, htmlspecialchars($CLefecto));
            $producto = mysqli_real_escape_string($this->conexion, htmlspecialchars($producto));
            $cabecera = mysqli_real_escape_string($this->conexion, htmlspecialchars($cabecera));
            $pie = mysqli_real_escape_string($this->conexion, htmlspecialchars($pie));
            
            $imgname = "";
                    if ($imagen['error'] != 4)
                                {
                                        $imgname = uniqid().'_'.$imagen['name'];
                                        move_uploaded_file($imagen['tmp_name'], '../source/'.$imgname);
                                        $imgname = ", fcabecera = '$imgname'";
                                }
            
            $sql = "UPDATE bd_configuracion
					SET inicio = $inicio, productos = $producto, cabecera = $cabecera, pie = $pie, gproductos = $productos, efecto = '$efecto', CFefecto = '$CFefecto', CLefecto = '$CLefecto' $imgname
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function ModificarCesta($etiqProCesta, $filaAtrCesta, $mmcesta, $trans, $promo){
            $etiqProCesta = mysqli_real_escape_string($this->conexion, htmlspecialchars($etiqProCesta));
            $filaAtrCesta = mysqli_real_escape_string($this->conexion, htmlspecialchars($filaAtrCesta));
            $mmcesta = mysqli_real_escape_string($this->conexion, htmlspecialchars($mmcesta));
            $cadena = '';
            
            if($trans != false){
				$trans = mysqli_real_escape_string($this->conexion, htmlspecialchars($trans));
                $cadena .= ",transporteIcon = '".$trans."'";
            }
			
			if($promo != false){
				$promo = mysqli_real_escape_string($this->conexion, htmlspecialchars($promo));
                $cadena .= ",promocionIcon = '".$promo."'";
            }
			
            $sql = "UPDATE bd_empresa
                        SET etiqProCesta = '$etiqProCesta', filaAtrCesta = '$filaAtrCesta', mmcesta = '$mmcesta' ".$cadena."
                        WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }


                function Modificarbuscador($etiqavanzado){
            $etiqavanzado = mysqli_real_escape_string($this->conexion, htmlspecialchars($etiqavanzado));
          
            
            $sql = "UPDATE bd_buscadoravanzado
                        SET activo = '$etiqavanzado' WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }


		
		function ConfiguracionModificar($empresa, $compGaleria, $cif, $email, $telefono, $telefono2, $telefono3, $wassap, $fax, $mapskey, $mapszoom, $mapscoor,
                $mcatalogo, $ordenacionI, $horario, $facebook, $googlep, $twitter, $youtube, $pinterest, $instagram, $linkedin, $etiqpro, $etiqAct, $tipoportes,
                $direccion, $provincia, $poblacion, $cp, $pais, $portes, $det_productos, $com_productos, $com_blog, $com_galerias, $contrareembolso, $mgfacebook, $mgflugar,
                $msgtop, $msgbottom, $msgdiasmax, $dominio, $descripcionHTML, $vgaleria, $impuesto, $desglose, $divisa, $tipomail, $emailSmtp, $passSmtp, $puertoSmtp, $hostSmtp, $segSmtp, $menu, $registro, $sesion, $httpsAc, $logo1, $logo2, $logo3, $icono, $imgfacebookD, $factura, $cestaU, $dPedido, $condiciones, $nacex, $chat, $rma, $rma_dias, $rma_gastos, $ftamano, $pnovlateral)
		{
			$empresa = mysqli_real_escape_string($this->conexion, htmlspecialchars($empresa));
			$cif = mysqli_real_escape_string($this->conexion, htmlspecialchars($cif));
			$email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$telefono = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono));
			$telefono2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono2));
                        $telefono3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefono3));
                        $wassap = mysqli_real_escape_string($this->conexion, htmlspecialchars($wassap));
			$fax = mysqli_real_escape_string($this->conexion, htmlspecialchars($fax));
                        $mapskey = mysqli_real_escape_string($this->conexion, htmlspecialchars($mapskey));
                        $mapszoom = mysqli_real_escape_string($this->conexion, htmlspecialchars($mapszoom));
                        $mapscoor = mysqli_real_escape_string($this->conexion, htmlspecialchars($mapscoor));
			$horario = mysqli_real_escape_string($this->conexion, htmlspecialchars($horario));
                        $ordenacionI = mysqli_real_escape_string($this->conexion, htmlspecialchars($ordenacionI));
                        $horario = html_entity_decode($horario);
			$facebook = mysqli_real_escape_string($this->conexion, htmlspecialchars($facebook));
			$googlep = mysqli_real_escape_string($this->conexion, htmlspecialchars($googlep));
			$twitter = mysqli_real_escape_string($this->conexion, htmlspecialchars($twitter));
			$youtube = mysqli_real_escape_string($this->conexion, htmlspecialchars($youtube));
			$pinterest = mysqli_real_escape_string($this->conexion, htmlspecialchars($pinterest));
			$instagram = mysqli_real_escape_string($this->conexion, htmlspecialchars($instagram));
                        $linkedin = mysqli_real_escape_string($this->conexion, htmlspecialchars($linkedin));
			$direccion = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccion));
			$provincia = mysqli_real_escape_string($this->conexion, htmlspecialchars($provincia));
			$poblacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($poblacion));
			$cp = mysqli_real_escape_string($this->conexion, htmlspecialchars($cp));
			$pais = mysqli_real_escape_string($this->conexion, htmlspecialchars($pais));
			$portes = mysqli_real_escape_string($this->conexion, htmlspecialchars($portes));
			$contrareembolso = mysqli_real_escape_string($this->conexion, htmlspecialchars($contrareembolso));
			$msgtop = mysqli_real_escape_string($this->conexion, htmlspecialchars($msgtop));
			$msgbottom = mysqli_real_escape_string($this->conexion, htmlspecialchars($msgbottom));
                        $msgdiasmax = mysqli_real_escape_string($this->conexion, htmlspecialchars($msgdiasmax));
			$dominio = mysqli_real_escape_string($this->conexion, htmlspecialchars($dominio));
                        $descripcionHTML = mysqli_real_escape_string($this->conexion, htmlspecialchars($descripcionHTML));
                        $impuesto = mysqli_real_escape_string($this->conexion, htmlspecialchars($impuesto));
                        $menu = mysqli_real_escape_string($this->conexion, htmlspecialchars($menu));
                        $desglose = mysqli_real_escape_string($this->conexion, htmlspecialchars($desglose));
                        $divisa = mysqli_real_escape_string($this->conexion, htmlspecialchars($divisa));
                        $tipomail = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipomail));
                        $emailSmtp = mysqli_real_escape_string($this->conexion, htmlspecialchars($emailSmtp));
                        $passSmtp = mysqli_real_escape_string($this->conexion, htmlspecialchars($passSmtp));
                        $puertoSmtp = mysqli_real_escape_string($this->conexion, htmlspecialchars($puertoSmtp));
                        $hostSmtp = mysqli_real_escape_string($this->conexion, htmlspecialchars($hostSmtp));
                        $segSmtp = mysqli_real_escape_string($this->conexion, htmlspecialchars($segSmtp));
                        $registro = mysqli_real_escape_string($this->conexion, htmlspecialchars($registro));
                        $mcatalogo = mysqli_real_escape_string($this->conexion, htmlspecialchars($mcatalogo));
                        $sesion = mysqli_real_escape_string($this->conexion, htmlspecialchars($sesion));
                        $httpsAc = mysqli_real_escape_string($this->conexion, htmlspecialchars($httpsAc));
                        $factura = mysqli_real_escape_string($this->conexion, htmlspecialchars($factura));
                        $cestaU = mysqli_real_escape_string($this->conexion, htmlspecialchars($cestaU));
                        $dPedido = mysqli_real_escape_string($this->conexion, htmlspecialchars($dPedido));
                        $condiciones = mysqli_real_escape_string($this->conexion, htmlspecialchars($condiciones));
                        $nacex = mysqli_real_escape_string($this->conexion, htmlspecialchars($nacex));
                        $chat = mysqli_real_escape_string($this->conexion, htmlspecialchars($chat));
                        $chat = html_entity_decode($chat);
                        $rma = mysqli_real_escape_string($this->conexion, htmlspecialchars($rma));
                        $rma_dias = mysqli_real_escape_string($this->conexion, htmlspecialchars($rma_dias));
                        $rma_gastos = mysqli_real_escape_string($this->conexion, htmlspecialchars($chat));
                        $ftamano = mysqli_real_escape_string($this->conexion, htmlspecialchars($ftamano));
                        $com_productos = mysqli_real_escape_string($this->conexion, htmlspecialchars($com_productos));
                        $det_productos = mysqli_real_escape_string($this->conexion, htmlspecialchars($det_productos));
                        $com_blog = mysqli_real_escape_string($this->conexion, htmlspecialchars($com_blog));
                        $com_galerias = mysqli_real_escape_string($this->conexion, htmlspecialchars($com_galerias));
                        $pnovlateral = mysqli_real_escape_string($this->conexion, htmlspecialchars($pnovlateral));
                        $vgaleria = mysqli_real_escape_string($this->conexion, htmlspecialchars($vgaleria));
                        $etiqpro = mysqli_real_escape_string($this->conexion, htmlspecialchars($etiqpro));
                        $etiqAct = mysqli_real_escape_string($this->conexion, htmlspecialchars($etiqAct));
                        $tipoportes = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipoportes));
                        $mgfacebook = mysqli_real_escape_string($this->conexion, htmlspecialchars($mgfacebook));
                        $mgflugar = mysqli_real_escape_string($this->conexion, htmlspecialchars($mgflugar));
                        $compGaleria = mysqli_real_escape_string($this->conexion, htmlspecialchars($compGaleria));
                        
                        if(substr($mgfacebook, -1) == '/'){
                            $mgfacebook = substr($mgfacebook , 0 , -1);
                        }
			
                    $sql = "UPDATE bd_configuracion
                            SET conectado = $sesion
                            WHERE id = 1;";
                    mysqli_query($this->conexion, $sql);

                    $imgname = "";
                    if ($logo1['error'] != 4)
                                {
                                        $imgname = uniqid().'_'.$logo1['name'];
                                        move_uploaded_file($logo1['tmp_name'], '../source/'.$imgname);
                                        $imgname = ", logosup = '$imgname'";
                                }

                    $imgname2 = "";
                                if ($logo2['error'] != 4)
                                {
                                        $imgname2 = uniqid().'_'.$logo2['name'];
                                        move_uploaded_file($logo2['tmp_name'], '../source/'.$imgname2);
                                        $imgname2 = ", logoinf = '$imgname2'";
                                }
                                
                    $imgname4 = "";
                                if ($logo3['error'] != 4)
                                {
                                        $imgname4 = uniqid().'_'.$logo3['name'];
                                        move_uploaded_file($logo3['tmp_name'], '../source/'.$imgname4);
                                        $imgname4 = ", logomenu = '$imgname4'";
                                }

                    $imgname3 = "";
                                if ($icono['error'] != 4)
                                {
                                        $imgname3 = uniqid().'_'.$icono['name'];
                                        move_uploaded_file($icono['tmp_name'], '../icono/'.$imgname3);
                                        $imgname3 = ", icono = '$imgname3'";
                                }
                    
                    $imgname5 = "";
                                if ($imgfacebookD['error'] != 4)
                                {
                                        $imgname5 = uniqid().'_'.$imgfacebookD['name'];
                                        move_uploaded_file($imgfacebookD['tmp_name'], '../source/'.$imgname5);
                                        $imgname5 = ", imgfacebookD = '$imgnam5'";
                                }

                    $sql = "UPDATE bd_empresa
                        SET nombre = '$empresa', cif = '$cif', email = '$email',
                            telefono = '$telefono', telefono2 = '$telefono2', telefono3 = '$telefono3', wassap = '$wassap', facebook = '$facebook', mapskey = '$mapskey', mapszoom = '$mapszoom', mapscoor = '$mapscoor', ordenacion = '$ordenacionI',
                            google = '$googlep', twitter = '$twitter', youtube = '$youtube', pinterest = '$pinterest', instagram = '$instagram', linkedin = '$linkedin', etiqpro = '$etiqpro', etiqAct = '$etiqAct', tipoportes = '$tipoportes',
                            mcatalogo = '$mcatalogo', direccion = '$direccion', ftamano = '$ftamano', det_producto = '$det_productos', com_producto = '$com_productos', com_blog = '$com_blog', com_galeria = '$com_galerias', mgflugar = '$mgflugar',
                            provincia = '$provincia', localidad = '$poblacion', cp = '$cp', pais = '$pais', pnovlateral = '$pnovlateral', vgaleria = '$vgaleria', mgfacebook = '$mgfacebook',
                            portesgratis = '$portes', tasacontrareembolso = '$contrareembolso', chat = '$chat', rma = '$rma', rma_dias = '$rma_dias', rma_gastos = '$rma_gastos', httpsAc = '$httpsAc',
                            fax = '$fax', horario = '$horario', factura = '$factura', cestaU = '$cestaU', dPedido = '$dPedido', condiciones = '$condiciones', nacex = '$nacex', compGaleria = '$compGaleria',
                            msgtop = '$msgtop', msgbottom = '$msgbottom', msgdiasmax = '$msgdiasmax', dominio = '$dominio', descripcionHTML = '$descripcionHTML', impuesto = $impuesto, desglose = $desglose, moneda = '$divisa',
                            envimail = '$tipomail', mailSmtp = '$emailSmtp', passSmtp = '$passSmtp', puertoSmtp = '$puertoSmtp', hostSmtp = '$hostSmtp', segSmtp = '$segSmtp', menu = '$menu', registro = '$registro'$imgname $imgname2 $imgname4 $imgname3 $imgname5
                        WHERE id = 1;";
                     $query = mysqli_query($this->conexion, $sql);
            
			
			return $query;
		}
                
        function ConfiguracionModificarNacex($user, $pass, $delegacion, $ccliente){
            $user = mysqli_real_escape_string($this->conexion, htmlspecialchars($user));
            $pass = mysqli_real_escape_string($this->conexion, htmlspecialchars($pass));
            $delegacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($delegacion));
            $ccliente = mysqli_real_escape_string($this->conexion, htmlspecialchars($ccliente));
            
            $sql = "UPDATE bd_nacex
                SET user = '$user', pass = '$pass', delegacion = '$delegacion',
                    cliente = '$ccliente' WHERE id = 1;";
             $query = mysqli_query($this->conexion, $sql);
            
			
			return $query;
        }
        
        function FuentesModificar($f1, $f2){
            
            $f1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($f1));
            $f2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($f2));
            
            $sql = "UPDATE bd_fuentes SET fuente1 = '$f1', fuente2 = '$f2'";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function ModificarCabeceraPie($f1, $f3, $f2){
            
            $f1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($f1));
            $f2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($f2));
            $f3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($f3));
            
            $f1 = html_entity_decode($f1);
            $f2 = html_entity_decode($f2);
            $f3 = html_entity_decode($f3);
            
            $sql = "UPDATE bd_empresa SET cabecera = '$f1', pie = '$f2', pieS = '$f3' WHERE id = 1";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function MensajePModificar($mp1, $mp2, $mp3, $mp4){
            
            $mp1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp1));
            $mp2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp2));
            $mp3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp3));
            $mp4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp4));
            
            $sql = "UPDATE bd_empresa SET actanu = '$mp1', enlvid = '$mp2', anchvid = '$mp3', luganu = '$mp4' WHERE id = 1";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
            
        }
        
        function ColoresModificar($c1, $c2, $c3, $c4, $c5, $c6,
                $c7, $c8, $c9, $c10, $c11, $c12, $c13,
                $c14, $c15, $c16, $c17, $c18, $c19, $c20,
                $c21, $c22, $c23, $c24, $g1, $g2, $g3, $g4, $g5, $g6, $g7, $g8, $g9, $mp1, $mp2, $mp3, $mp4, $mp5, $mp6, $mp7, $mp8, $mp9, $ba1, $ba2, $ba3, $ba4)
		{
			$c1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c1));
			$c2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c2));
			$c3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c3));
			$c4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c4));
			$c5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c5));
			$c6 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c6));
			$c7 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c7));
			$c8 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c8));
			$c9 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c9));
			$c10 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c10));
			$c11 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c11));
			$c12 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c12));
			$c13 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c13));
			$c14 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c14));
			$c15 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c15));
			$c16 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c16));
			$c17 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c17));
			$c18 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c18));
			$c19 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c19));
			$c20 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c20));
			$c21 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c21));
			$c22 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c22));
                        $c23 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c23));
			$c24 = mysqli_real_escape_string($this->conexion, htmlspecialchars($c24));
                        
                        $g1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g1));
                        $g2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g2));
                        $g3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g3));
                        $g4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g4));
                        $g5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g5));
                        $g6 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g6));
                        $g7 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g7));
                        $g8 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g8));
                        $g9 = mysqli_real_escape_string($this->conexion, htmlspecialchars($g9));
                        
                        $mp1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp1));
                        $mp2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp2));
                        $mp3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp3));
                        $mp4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp4));
                        $mp5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp5));
                        $mp6 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp6));
                        $mp7 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp7));
                        $mp8 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp8));
                        $mp9 = mysqli_real_escape_string($this->conexion, htmlspecialchars($mp9));
                        
                        $ba1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($ba1));
                        $ba2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($ba2));
                        $ba3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($ba3));
                        $ba4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($ba4));
                        
			
			$sql = "UPDATE bd_colores
					SET colorgaleriamain = '$c1', colorbotonesmain = '$c2', colorbotoneshovermain = '$c3',
						colorposbarmain = '$c4', colorenlacemain = '$c5', colortextomain = '$c6', 
						colorbordeprodsmain = '$c7', colortextoprodsmain = '$c8', colorgeneralinicio = '$c9', colorbotonform = '$c10', colorbotonhoverform = '$c11',
						colortextobotonform = '$c12', AnaCestaB = '$ba1', AnaCestaT = '$ba2', AnaCestaBH = '$ba3', AnaCestaTH = '$ba4',
						colorprecioprod = '$c13', colortextoprod = '$c14', colorprecioprods = '$c15', colortextoordenarprods = '$c16',
                        colortextoprods = '$c17', enlacesubmenuresp = '$c18',
                        bordesubmenuhoverresp = '$c19', fondosubmenuhoverresp = '$c20', colorgeneralresp = '$c21', colorgeneralprodsresp = '$c22', colorlogotop = '$c23', colorlogobot = '$c24'
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
                        
                        $sql = "UPDATE bd_colores_productos
					SET oferta_fondo = '$g1', oferta_letra = '$g2', precio_color = '$g3',
						nombre_color = '$g4', nombre_color_hover = '$g5', boton_fondo = '$g6', 
						boton_letras = '$g7', boton_fondo_hover = '$g8', boton_letras_hover = '$g9',
                                                barra_sup = '$mp1', menu = '$mp2', menu_letra = '$mp3',
						menu_letra_hover = '$mp4', pie = '$mp5', pie_letras = '$mp6', venta_fondo ='$mp7', alquiler_fondo = '$mp8', agotado_fondo = '$mp9'
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
		
		function ConfiguracionModificarBloques($blq1, $blq2, $blq3, $blq4, $blq5, $blq6, $blq7, $blq8)
		{
			$blq1 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq1));
			$blq2 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq2));
			$blq3 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq3));
			$blq4 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq4));
			$blq5 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq5));
			$blq6 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq6));
			$blq7 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq7));
			$blq8 = mysqli_real_escape_string($this->conexion, htmlspecialchars($blq8));
            
            if ($blq1 != '') $blq1 = "'$blq1'"; else $blq1 = 'null';
            if ($blq2 != '') $blq2 = "'$blq2'"; else $blq2 = 'null';
            if ($blq3 != '') $blq3 = "'$blq3'"; else $blq3 = 'null';
            if ($blq4 != '') $blq4 = "'$blq4'"; else $blq4 = 'null';
            if ($blq5 != '') $blq5 = "'$blq5'"; else $blq5 = 'null';
            if ($blq6 != '') $blq6 = "'$blq6'"; else $blq6 = 'null';
            if ($blq7 != '') $blq7 = "'$blq7'"; else $blq7 = 'null';
            if ($blq8 != '') $blq8 = "'$blq8'"; else $blq8 = 'null';
			
			$sql = "UPDATE bd_empresa
					SET idcate1 = $blq1, idcate2 = $blq2, idcate3 = $blq3,
                    idcate4 = $blq4, idcate5 = $blq5, idcate6 = $blq6,
                    idcate7 = $blq7, idcate8 = $blq8
					WHERE activa = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
                function Ayuda($seccion){
                    $dev = '';
                    $sql = "SELECT * FROM bd_ayuda WHERE seccion = '$seccion';";
                    $query = mysqli_query($this->conexion, $sql);
                    if (mysqli_num_rows($query) > 0)
                    {
                        $activo = mysqli_fetch_assoc($query);
                        $dev .= $activo['texto'];
                    }else{
                        $dev .= 'Actualmente, este apartado, no tiene ayuda disponible.';
                    }
                    
                        
                    return $dev;
                }
	
        
        function NuevaCuota($meses)
		{
			$meses = mysqli_real_escape_string($this->conexion, htmlspecialchars($meses));
			
			$sql = "INSERT INTO bd_productos_cuotas
					VALUES (null, $meses);";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function ModificarCuota($id, $meses)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$meses = mysqli_real_escape_string($this->conexion, htmlspecialchars($meses));
			
			$sql = "UPDATE bd_productos_cuotas
					SET meses = '$meses'
                    WHERE id_c = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function CargarCuotas($limit = 10000)
		{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_productos_cuotas
					ORDER BY id_c ASC
					LIMIT $limit;";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function CargarCuota($id)
		{
			$resultado = null;
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "SELECT *
					FROM bd_productos_cuotas
					WHERE id_c = $id
					ORDER BY id_c ASC;";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;;
		}
        function CuotaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_productos_cuotas
					WHERE id_c = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function CargarCuotasProds($id)
		{
            $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_productos_fdirecta
                    WHERE idproducto = $id;";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
                
        function ProductoEditarCuota($atr, $idp, $precio){
            $sql = "SELECT *
					FROM bd_productos_fdirecta
                    WHERE idproducto = $idp AND meses = $atr;";
            $query = mysqli_query($this->conexion, $sql);
            
            
            if(mysqli_num_rows($query) == 1){
                $sql = "UPDATE bd_productos_fdirecta
                        SET cuota = $precio
                        WHERE idproducto = $idp AND meses = $atr;";
                $query2 = mysqli_query($this->conexion, $sql);
            }else{
                $sql = "INSERT INTO bd_productos_fdirecta
                        VALUES (null, $idp, $atr, $precio);";
                $query2 = mysqli_query($this->conexion, $sql);
            }
        }
        
        function ProductoNuevoCuota($atr,$precio){
            $sql = "INSERT INTO bd_productos_fdirecta
					VALUES (null, 0, $atr, $precio);";
			$query = mysqli_query($this->conexion, $sql);
        }
        
        
        function EnvíoNacex($idf, $tservicio, $tcobro, $tenvio, $bultos, $kilos, $envase, $vrecogida, $nombreE, $direccionE, $cpE, $localidadE, $telefonoE, $paisE, $Contenido, $vdeclarado){
            $idf = mysqli_real_escape_string($this->conexion, htmlspecialchars($idf));
            $tservicio = mysqli_real_escape_string($this->conexion, htmlspecialchars($tservicio));
            $tcobro = mysqli_real_escape_string($this->conexion, htmlspecialchars($tcobro));
            $tenvio = mysqli_real_escape_string($this->conexion, htmlspecialchars($tenvio));
            $bultos = mysqli_real_escape_string($this->conexion, htmlspecialchars($bultos));
            $kilos = mysqli_real_escape_string($this->conexion, htmlspecialchars($kilos));
            $envase = mysqli_real_escape_string($this->conexion, htmlspecialchars($envase));
            $vrecogida = mysqli_real_escape_string($this->conexion, htmlspecialchars($vrecogida)); 
            $nombreE = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombreE));
            $direccionE = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccionE));
            $cpE = mysqli_real_escape_string($this->conexion, htmlspecialchars($cpE));
            $localidadE = mysqli_real_escape_string($this->conexion, htmlspecialchars($localidadE));
            $telefonoE = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefonoE));
            $paisE = mysqli_real_escape_string($this->conexion, htmlspecialchars($paisE));
            $Contenido = mysqli_real_escape_string($this->conexion, htmlspecialchars($Contenido));
            $vdeclarado = mysqli_real_escape_string($this->conexion, htmlspecialchars($vdeclarado));
              
            if(count($bultos)<3){
                if(count($bultos)==2)
                    $bultos = '0'.$bultos;
                else if(count($bultos)==1)
                    $bultos = '00'.$bultos;
            }
            $fecha=date("d/m/Y");
            
            $sql = "SELECT * FROM bd_nacex WHERE id=1";
            $query = mysqli_query($this->conexion, $sql);
            if (mysqli_num_rows($query) > 0){
		$assoc = mysqli_fetch_assoc($query);
                $usuario = $assoc['user'];
                $pass = md5($assoc['pass']);
                $delegacion = $assoc['delegacion'];
                $ccliente = $assoc['cliente'];
            
                if($Contenido == '' && $vdeclarado == ''){
                    $cadena= "http://gprs.nacex.com/nacex_ws/ws?method=putExpedicion&user=$usuario&pass=$pass&data=del_cli=$delegacion|num_cli=$ccliente|fec=$fecha|tip_ser=$tservicio|tip_cob=$tcobro|tip_env=$tenvio"
                            . "|bul=$bultos|kil=$kilos|nom_ent=".rawurlencode($nombreE)."|dir_ent=".rawurlencode($direccionE)."|pais_ent=".strtoupper(substr(rawurlencode($paisE),0,2))."|cp_ent=".rawurlencode($cpE)."|pob_ent=".rawurlencode($localidad)."|tel_ent=".rawurlencode($telefono);
                }else{
                    $cadena= "http://gprs.nacex.com/nacex_ws/ws?method=putExpedicion&user=$usuario&pass=$pass&data=del_cli=$delegacion|num_cli=$ccliente|fec=$fecha|tip_ser=$tservicio|tip_cob=$tcobro|tip_env=$tenvio"
                            . "|bul=$bultos|kil=$kilos|nom_ent=".rawurlencode($nombreE)."|dir_ent=".rawurlencode($direccionE)."|pais_ent=".strtoupper(substr(rawurlencode($paisE),0,2))."|cp_ent=".rawurlencode($cpE)."|pob_ent=".rawurlencode($localidad)."|tel_ent=".rawurlencode($telefono)."|con=".rawurlencode($Contenido)."|val_dec=".rawurlencode($vdeclarado);
                }
                
                $ch = curl_init($cadena);
		//a true, obtendremos una respuesta de la url, en otro caso, 
		//true si es correcto, false si no lo es
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		//establecemos el verbo http que queremos utilizar para la petición
		curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
		//obtenemos la respuesta
		$response = curl_exec($ch);
		// Se cierra el recurso CURL y se liberan los recursos del sistema
		curl_close($ch);
		if(!$response) {
		    return "ERROR EN LA CONEXIÓN CON NACEX";
		}else{
                    $response=utf8_encode($response);
                    $respuesta = explode("|", $response);
                    
                    if($respuesta[0] != "ERROR"){
                        $sql = "INSERT INTO `bd_nacex_envios_ok`(`id`, `id_fact`, `cod_expedicion`, `fecha`, `cad_devuelta`) VALUES (null,$idf,'$respuesta[0]','$respuesta[10]','$response')";
                        $query = mysqli_query($this->conexion, $sql);
                    }else if($respuesta[0] == "ERROR"){
                        $sql = "INSERT INTO `bd_nacex_envios_ko`(`id`, `id_fact`, `cad_devuelta`) VALUES (null,$idf,'$response')";
                        $query = mysqli_query($this->conexion, $sql);
                    }else{
                        $sql = "INSERT INTO `bd_nacex_envios_ko`(`id`, `id_fact`, `cad_devuelta`) VALUES (null,$idf,'ERROR DESCONOCIDO')";
                        $query = mysqli_query($this->conexion, $sql);
                    }
                    
                    return explode("|", $response);
		}
               
            }else{
                return "ERROR EN LA CONEXIÓN CON NACEX";
            } 
        }
        
        function CargarEstadoNacex($id){
            $sql = "SELECT * FROM bd_nacex_envios_ok WHERE id_fact = $id";
            $query = mysqli_query($this->conexion, $sql);
            if(mysqli_num_rows($query) == 0)
                $resultado = 0;
            else if (mysqli_num_rows($query) > 0)
            {
		$assoc = mysqli_fetch_assoc($query);
		$resultado = $assoc;
            } 
                
            return $resultado;
        }
        
        function DatosNacex(){
            $sql = "SELECT * FROM bd_nacex WHERE id = 1";
            $query = mysqli_query($this->conexion, $sql);
            if (mysqli_num_rows($query) > 0)
            {
		$assoc = mysqli_fetch_assoc($query);
		$resultado = $assoc;
            } 
                
            return $resultado;
        }
        
        function MenuActualizaOrden($id, $valor){
            $sql = "UPDATE bd_menu SET orden = '$valor' WHERE id = '$id'";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
        }
        
        function CargarTiendas($limit = 10000, $orden = 'id DESC')
	{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_tiendas
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
        }
        
        function CargarExtras($limit = 10000, $orden = 'id DESC')
	{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_campos_pedido
					ORDER BY $orden
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
        }
        
        function CargarTienda($id = 1)
	{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_tiendas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
	}
        
        function CargarExtra($id = 1)
	{
			$resultado = null;
			
			$sql = "SELECT *
					FROM bd_campos_pedido
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
			{
				$assoc = mysqli_fetch_assoc($query);
				$resultado = $assoc;
			}

			return $resultado;
	}
        
        function TiendaModificar($id, $nombre, $direccion, $telefonos, $email, $descripcion, $descripcion_en = null, $descripcion_al = null,$descripcion_fr = null,
                         $descripcion_it = null, $descripcion_po = null, $descripcion_ca = null, $descripcion_ru = null, $img)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$direccion = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccion));
                        $telefonos = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefonos));
                        $email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
			$descripcion_en = mysqli_real_escape_string($this->conexion, $descripcion_en);
			$descripcion_al = mysqli_real_escape_string($this->conexion, $descripcion_al);
			$descripcion_fr = mysqli_real_escape_string($this->conexion, $descripcion_fr);
			$descripcion_it = mysqli_real_escape_string($this->conexion, $descripcion_it);
			$descripcion_po = mysqli_real_escape_string($this->conexion, $descripcion_po);
                        $descripcion_ca = mysqli_real_escape_string($this->conexion, $descripcion_ca);
                        $descripcion_ru = mysqli_real_escape_string($this->conexion, $descripcion_ru);
			
            $imgname = "";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenesTiendas/'.$imgname);
				$imgname = ", imagen = '$imgname'";
			}
			
			$sql = "UPDATE bd_tiendas
					SET nombre = '$nombre', direccion = '$direccion', telefonos = '$telefonos', email = '$email', descripcion = '$descripcion', descripcion_en = '$descripcion_en', descripcion_al = '$descripcion_al', descripcion_fr = '$descripcion_fr', descripcion_it = '$descripcion_it', descripcion_po = '$descripcion_po', descripcion_ca = '$descripcion_ca', descripcion_ru = '$descripcion_ru'$imgname
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function ExtraModificar($id, $nombre, $tipo)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$tipo = mysqli_real_escape_string($this->conexion, htmlspecialchars($tipo));

			$sql = "UPDATE bd_campos_pedido
					SET nombre = '$nombre', tipo = '$tipo'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function TiendaNueva($nombre, $direccion, $telefonos, $email, $descripcion, $descripcion_en = null, $descripcion_al = null,$descripcion_fr = null,
                         $descripcion_it = null, $descripcion_po = null, $descripcion_ca = null, $descripcion_ru = null, $img)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			$direccion = mysqli_real_escape_string($this->conexion, htmlspecialchars($direccion));
                        $telefonos = mysqli_real_escape_string($this->conexion, htmlspecialchars($telefonos));
                        $email = mysqli_real_escape_string($this->conexion, htmlspecialchars($email));
			$descripcion = mysqli_real_escape_string($this->conexion, $descripcion);
			$descripcion_en = mysqli_real_escape_string($this->conexion, $descripcion_en);
			$descripcion_al = mysqli_real_escape_string($this->conexion, $descripcion_al);
			$descripcion_fr = mysqli_real_escape_string($this->conexion, $descripcion_fr);
			$descripcion_it = mysqli_real_escape_string($this->conexion, $descripcion_it);
			$descripcion_po = mysqli_real_escape_string($this->conexion, $descripcion_po);
                        $descripcion_ca = mysqli_real_escape_string($this->conexion, $descripcion_ca);
                        $descripcion_ru = mysqli_real_escape_string($this->conexion, $descripcion_ru);
			
            $imgname = "'',";
			if ($img['error'] != 4)
			{
				$imgname = uniqid().'_'.$img['name'];
				move_uploaded_file($img['tmp_name'], '../imagenesTiendas/'.$imgname);
				$imgname = "'$imgname',";
			}
			
			$sql = "INSERT INTO bd_tiendas VALUES
					(null, '$nombre', '$direccion', '$telefonos', '$email', '$descripcion', $imgname '$descripcion_en', '$descripcion_al', '$descripcion_fr', '$descripcion_it', '$descripcion_po', '$descripcion_ru', '$descripcion_ca');";
			
                        $query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}

        function ExtraNuevo($nombre, $tipo)
		{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));

			$sql = "INSERT INTO bd_campos_pedido VALUES
					(null, '$nombre', '$tipo');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
        
        function TiendaEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_tiendas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
           
        function ExtraEliminar($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_campos_pedido
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
           
        function TiendaEliminarI($id)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "UPDATE bd_tienda SET imagen = ''
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function NacexSiNo(){
            
            
            $sql = "SELECT nacex
					FROM bd_empresa
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
			
			
            $assoc = mysqli_fetch_assoc($query);
                        
            return $assoc['nacex'];
        }
        
        function estadoGE(){
            $sql = "SELECT desactivarGE
					FROM bd_empresa
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
			
			
            $assoc = mysqli_fetch_assoc($query);
                        
            return $assoc['desactivarGE'];
        }
        
        function GuardarIconos($facebook, $twitter, $gplus, $pinterest, $instagram, $youtube, $linkedin){
            
            $cadena = '';
            
            if($facebook != false){
                $cadena .= "facebookIcon = 'facebook.".$facebook."',";
            }
            if($twitter != false){
                $cadena .= "twitterIcon = 'twitter.".$twitter."',";
            }
            if($gplus != false){
                $cadena .= "gplusIcon = 'gplus.".$gplus."',";
            }
            if($pinterest != false){
                $cadena .= "pinterestIcon = 'pinterest.".$pinterest."',";
            }
            if($instagram != false){
                $cadena .= "instagramIcon = 'instagram.".$instagram."',";
            }
            if($youtube != false){
                $cadena .= "youtubeIcon = 'youtube.".$youtube."',";
            }
            if($linkedin != false){
                $cadena .= "linkedinIcon = 'linkedin.".$linkedin."',";
            }
            
            $cadena = substr($cadena, 0, -1);
            
            $sql = "UPDATE bd_empresa SET ".$cadena."
					WHERE id = 1;";
            
            $query = mysqli_query($this->conexion, $sql);
			
            return $query;     
        }
        
        function EliminarIconoRed($red){
            $cadena = '';
            switch ($red){
                case 'facebook': $cadena = 'facebookIcon = ""';
                    break;
                case 'twitter': $cadena = 'twitterIcon = ""';
                    break;
                case 'gplus': $cadena = 'gplusIcon = ""';
                    break;
                case 'pinterest': $cadena = 'pinterestIcon = ""';
                    break;
                case 'instagram': $cadena = 'instagramIcon = ""';
                    break;
                case 'youtube': $cadena = 'youtubeIcon = ""';
                    break;
                case 'linkedin': $cadena = 'linkedinIcon = ""';
                    break;
                case 'transporte': $cadena = 'transporteIcon = ""';
                    break;
                case 'promocion': $cadena = 'promocionIcon = ""';
                    break;
            }
            $sql = "UPDATE bd_empresa SET ".$cadena."
					WHERE id = 1;";
            
            $query = mysqli_query($this->conexion, $sql);
			
            return $query; 
            
        }
        
        function CargarEtiquetas($limit = 10000)
	{
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_etiquetas
                                        WHERE id > 0
					ORDER BY nombre ASC, id ASC
					LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
	}
                
        function CargarEtiqueta($id)
	{
			$resultado =null;
			
			$sql = "SELECT *
					FROM bd_etiquetas
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultado = $assoc;

			return $resultado;
	}
        
        function EtiquetaNueva($nombre)
	{
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
                        
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
			
			$sql = "INSERT INTO bd_etiquetas
					VALUES (null, '$nombre');";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
        
        function ModificarEtiqueta($id, $nombre)
	{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $menu = mysqli_real_escape_string($this->conexion, htmlspecialchars($menu));
			if (@$padre == null || @$padre == '') $padre = 'null';
			$padre = mysqli_real_escape_string($this->conexion, htmlspecialchars($padre));
			
			$sql = "UPDATE bd_etiquetas
					SET nombre = '$nombre'
                    WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
                
        function EtiquetaEliminar($id)
	{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			
			$sql = "DELETE FROM bd_etiquetas
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
        
        function CargarEtiquetasProds()
		{
			$resultados = array();
			
			$sql = "SELECT * FROM bd_etiquetas ORDER BY nombre;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		}
        
        function CargarEtiquetaProds($id)
	{
            $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$resultados = array();
			
			$sql = "SELECT *
					FROM bd_producto_etiqueta
                    WHERE idproducto = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
	}
        
        function EliminarEtiquetas($idp){       
            $sql = "DELETE FROM bd_producto_etiqueta
                    WHERE idproducto = $idp;";
            return mysqli_query($this->conexion, $sql);           
        }
        
        function ProductoEditarEtiq($atr, $idp){
            $sql = "INSERT INTO bd_producto_etiqueta
                            VALUES (null, $idp, $atr);";
               
            $query2 = mysqli_query($this->conexion, $sql);
            
        }
        
        function CargarActPresupuestos()
		{
			$sql = "SELECT preSoli, preRegis
					FROM bd_empresa";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
                
        function CargarPresupuestos()
		{
			$sql = "SELECT p.*, u.nombre, u.email, u.telefono, u.direccion, u.poblacion
					FROM bd_presupuestos p ,bd_users u
                                        WHERE p.user = u.id
                                        UNION
                                        SELECT p.*, '-', '-', '-', '-', '-'
                                        FROM bd_presupuestos p
                                        WHERE p.user = 0
                                         ORDER BY fecha DESC";
                        
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;
                    
            return $resultados;
		}
                
        function ActivarPresupuesto($activacion)
		{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET preSoli = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function ActivarRegistroOblPre($activacion)
		{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET preRegis = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
                
        function CrearCSVProductos(){
            
            $csv_end = "\n";  
            $csv_sep = "$"; 
            $csv_env = "";
            $csv_file = "../feed/feedgeneral.csv";  
            $csv="";  
            $sql="SELECT * from bd_productos";  
            $res=mysqli_query($this->conexion, $sql); 
            
             //Url web, metodos de pago e importes suplementarios
                $dominio = '';
                $tasaReembolso = -1;
                $transferencia = -1;
                $paypal = -1;
                $domiciliacion = -1;
                $entienda = -1;
                $tpv = -1;
                $sql4 = "SELECT * FROM bd_empresa WHERE id = '1'";
                $query4 = mysqli_query($this->conexion, $sql4);
                if (mysqli_num_rows($query4) > 0){
                    while ($assoc4 = mysqli_fetch_assoc($query4)){
                        $dominio = $assoc4['dominio'];
                        if($assoc4['tasacontrareembolso'] != '')
                            $tasaReembolso = $assoc4['tasacontrareembolso'];
                        if($assoc4['cuenta'] != '')
                            $transferencia = 0;
                        if($assoc4['paypal'] != '')
                            $paypal = $assoc4['ifpaypal'];  
                        if($assoc4['iban'] == 1)
                            $domiciliacion = 0;  
                        if($assoc4['entienda'] == 1)
                            $entienda = 0;  
                        if($assoc4['url'] != '')
                            $tpv = 0;  
                    }
                }
            
                $csv.=$csv_env."Número de artículo del comerciante".$csv_env.
                        $csv_sep.$csv_env."EAN / GTIN / Código de barras / UPC".$csv_env.
                        $csv_sep.$csv_env."Número original del artículo del fabricante (HAN/MPN)".$csv_env.
                        $csv_sep.$csv_env."Nombre del fabricante/marca".$csv_env.
                        $csv_sep.$csv_env."Nombre del producto".$csv_env.
                        $csv_sep.$csv_env."Precio (bruto)".$csv_env.
                        $csv_sep.$csv_env."Precio especial".$csv_env.
                        $csv_sep. $csv_env."Precio original".$csv_env.
                        $csv_sep.$csv_env."Plazo de entrega".$csv_env.
                        $csv_sep.$csv_env."Categoría del producto en la tienda".$csv_env.
                        $csv_sep.$csv_env."Descripción del producto".$csv_env.
                        $csv_sep.$csv_env."Características del producto / Otros atributos".$csv_env.
                        $csv_sep.$csv_env."URL del producto".$csv_env.
                        $csv_sep.$csv_env."URL de la imagen".$csv_env;
                
                if($tasaReembolso > -1){
                    $csv.= $csv_sep.$csv_env."Reembolso".$csv_env;
                }
                if($transferencia > -1){
                    $csv.= $csv_sep.$csv_env."Transferencia".$csv_env;
                }
                if($paypal > -1){
                    $csv.= $csv_sep.$csv_env."Paypal".$csv_env;
                }
                if($domiciliacion > -1){
                    $csv.= $csv_sep.$csv_env."Domiciliación".$csv_env;
                }
                if($entienda > -1){
                    $csv.= $csv_sep.$csv_env."Recogida en Tienda".$csv_env;
                }
                if($tpv > -1){
                    $csv.= $csv_sep.$csv_env."Tarjeta".$csv_env;
                }
                
                $csv .= $csv_end;
                
            while($row=mysqli_fetch_assoc($res))  
            {  
                $dev = 1;
                $categoria = "";
                $marca = "";
                //Sacar marca y categoría.
                if ($row['idmarca'] > 0){
                    $sql2 = "SELECT marca FROM bd_categorias WHERE id = '".$row['idmarca']."'";
                    $query2 = mysqli_query($this->conexion, $sql2);
                    if (mysqli_num_rows($query2) > 0){
			while ($assoc2 = mysqli_fetch_assoc($query2)){
                            $marca = $assoc2['categoria'];
                        }
                    }
                }
                
                if ($row['idcat'] > 0){
                    $sql2 = "SELECT categoria FROM bd_categorias WHERE id = '".$row['idcat']."'";
                    $query2 = mysqli_query($this->conexion, $sql2);
                    if (mysqli_num_rows($query2) > 0){
			while ($assoc2 = mysqli_fetch_assoc($query2)){
                            $categoria = $assoc2['categoria'];
                        }
                    }
                }
                
                //Precios
                $precio = $row['precio'] * (1+($row['iva']/100));
                $precioDes = ($row['precio'] * (($row['iva'] + 100) / 100)) - ($row['precio'] * ((($row['iva'] + 100) / 100) * ($row['descuento'] / 100))) - ($row['descuentoe']);
                
                //Sacar cadena de atributos del producto.
                $atributos = "";
                $temp_at = "";
                $sql3 = "SELECT a.atributo AS valor, at.atributo AS tipo FROM bd_producto_atributo pa, bd_atributo a, bd_atributo_tipo at WHERE pa.idproducto = '".$row['id']."' AND pa.idatributo = a.id AND a.tipoid = at.id";
                    $query3 = mysqli_query($this->conexion, $sql3);
                    if (mysqli_num_rows($query3) > 0){
			while ($assoc3 = mysqli_fetch_assoc($query3)){
                            if($temp_at != $assoc3['tipo'] && $temp_at == ""){
                                $temp_at = $assoc3['tipo'];
                                $atributos .= $assoc3['tipo'].':'.$assoc3['valor'];
                            }else if($temp_at != $assoc3['tipo']){
                                $temp_at = $assoc3['tipo'];
                                $atributos .= " | ".$assoc3['tipo'].':'.$assoc3['valor'];
                            }else if($temp_at == $assoc3['tipo']){
                                $atributos .= "-".$assoc3['valor'];
                            }
                        }
                    }
                
                //Nombre producto para url.
                $nombrePurl = strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $row['nombre'])));; 
                        
                $csv.=$csv_env.$row['id'].$csv_env.
                        $csv_sep.$csv_env.$row['id'].$csv_env.
                        $csv_sep.$csv_env.$row['referencia'].$csv_env.
                        $csv_sep.$csv_env.$marca.$csv_env. 
                        $csv_sep.$csv_env.$row['nombre'].$csv_env.
                        $csv_sep.$csv_env.$precio.$csv_env.
                        $csv_sep.$csv_env.$precioDes.$csv_env.
                        $csv_sep.$csv_env.$precio.$csv_env.
                        $csv_sep.$csv_env.$row['plazoEnt'].$csv_env.
                        $csv_sep.$csv_env.$categoria.$csv_env.
                        $csv_sep.$csv_env.str_replace("\r", " ", str_replace("\n", " ", trim($row['descripcion']))).$csv_env.
                        $csv_sep.$csv_env.$atributos.$csv_env.
                        $csv_sep.$csv_env.$dominio.'/producto/'.$row['id'].'/'.$nombrePurl.$csv_env.
                        $csv_sep.$csv_env.$dominio.'/imagenesproductos/'.$row['imagenprincipal'].$csv_env;  
                
                if($tasaReembolso > -1){
                    $csv.= $csv_sep.$csv_env.number_format($tasaReembolso, 2, '.', ",").$csv_env;
                }
                if($transferencia > -1){
                    $csv.= $csv_sep.$csv_env.number_format($transferencia, 2, '.', ",").$csv_env;
                }
                if($paypal > -1){
                    $csv.= $csv_sep.$csv_env.number_format($paypal, 2, '.', ",").$csv_env;
                }
                if($domiciliacion > -1){
                    $csv.= $csv_sep.$csv_env.number_format($domiciliacion, 2, '.', ",").$csv_env;
                }
                if($entienda > -1){
                    $csv.= $csv_sep.$csv_env.number_format($entienda, 2, '.', ",").$csv_env;
                }
                if($tpv > -1){
                    $csv.= $csv_sep.$csv_env.number_format($tpv, 2, '.', ",").$csv_env;
                }
                
                $csv .= $csv_end;
            }  
            //Generamos el csv de todos los datos  
            //$file = fopen("uploads/inmuebles.xml", "w");
            if (!$handle = fopen($csv_file, "w")) {  
                echo "Cannot open file";  
                $dev = 0;
                exit;  
            }  
            if (fwrite($handle, utf8_decode($csv)) === FALSE) {  
                echo "Cannot write to file";  
                $dev = 0;
                exit;  
            }  
            fclose($handle);  
            return $dev;
        }
        
		//Crear archivo para Google Merchant
		function CrearTXTProductos(){
            
            $csv_end = "\n";  
            $csv_sep = "\t"; 
            $csv_env = "";
            $csv_file = "../feed/feedgeneral.txt";  
            $csv="";  
            $sql="SELECT * from bd_productos";  
            $res=mysqli_query($this->conexion, $sql); 
            
             //Url web, metodos de pago e importes suplementarios
                $dominio = '';
                $tasaReembolso = -1;
                $transferencia = -1;
                $paypal = -1;
                $domiciliacion = -1;
                $entienda = -1;
                $tpv = -1;
                $sql4 = "SELECT * FROM bd_empresa WHERE id = '1'";
                $query4 = mysqli_query($this->conexion, $sql4);
                if (mysqli_num_rows($query4) > 0){
                    while ($assoc4 = mysqli_fetch_assoc($query4)){
                        $dominio = $assoc4['dominio'];
                        if($assoc4['tasacontrareembolso'] != '')
                            $tasaReembolso = $assoc4['tasacontrareembolso'];
                        if($assoc4['cuenta'] != '')
                            $transferencia = 0;
                        if($assoc4['paypal'] != '')
                            $paypal = $assoc4['ifpaypal'];  
                        if($assoc4['iban'] == 1)
                            $domiciliacion = 0;  
                        if($assoc4['entienda'] == 1)
                            $entienda = 0;  
                        if($assoc4['url'] != '')
                            $tpv = 0;  
                    }
                }
            
                $csv.=$csv_env."Número de artículo del comerciante".$csv_env.
                        $csv_sep.$csv_env."EAN / GTIN / Código de barras / UPC".$csv_env.
                        $csv_sep.$csv_env."Número original del artículo del fabricante (HAN/MPN)".$csv_env.
                        $csv_sep.$csv_env."Nombre del fabricante/marca".$csv_env.
                        $csv_sep.$csv_env."Nombre del producto".$csv_env.
                        $csv_sep.$csv_env."Precio (bruto)".$csv_env.
                        $csv_sep.$csv_env."Precio especial".$csv_env.
                        $csv_sep. $csv_env."Precio original".$csv_env.
                        $csv_sep.$csv_env."Plazo de entrega".$csv_env.
                        $csv_sep.$csv_env."Categoría del producto en la tienda".$csv_env.
                        $csv_sep.$csv_env."Descripción del producto".$csv_env.
                        $csv_sep.$csv_env."Características del producto / Otros atributos".$csv_env.
                        $csv_sep.$csv_env."URL del producto".$csv_env.
                        $csv_sep.$csv_env."URL de la imagen".$csv_env;
                
                if($tasaReembolso > -1){
                    $csv.= $csv_sep.$csv_env."Reembolso".$csv_env;
                }
                if($transferencia > -1){
                    $csv.= $csv_sep.$csv_env."Transferencia".$csv_env;
                }
                if($paypal > -1){
                    $csv.= $csv_sep.$csv_env."Paypal".$csv_env;
                }
                if($domiciliacion > -1){
                    $csv.= $csv_sep.$csv_env."Domiciliación".$csv_env;
                }
                if($entienda > -1){
                    $csv.= $csv_sep.$csv_env."Recogida en Tienda".$csv_env;
                }
                if($tpv > -1){
                    $csv.= $csv_sep.$csv_env."Tarjeta".$csv_env;
                }
                
                $csv .= $csv_end;
                
            while($row=mysqli_fetch_assoc($res))  
            {  
                $dev = 1;
                $categoria = "";
                $marca = "";
                //Sacar marca y categoría.
                if ($row['idmarca'] > 0){
                    $sql2 = "SELECT marca FROM bd_categorias WHERE id = '".$row['idmarca']."'";
                    $query2 = mysqli_query($this->conexion, $sql2);
                    if (mysqli_num_rows($query2) > 0){
			while ($assoc2 = mysqli_fetch_assoc($query2)){
                            $marca = $assoc2['categoria'];
                        }
                    }
                }
                
                if ($row['idcat'] > 0){
                    $sql2 = "SELECT categoria FROM bd_categorias WHERE id = '".$row['idcat']."'";
                    $query2 = mysqli_query($this->conexion, $sql2);
                    if (mysqli_num_rows($query2) > 0){
			while ($assoc2 = mysqli_fetch_assoc($query2)){
                            $categoria = $assoc2['categoria'];
                        }
                    }
                }
                
                //Precios
                $precio = $row['precio'] * (1+($row['iva']/100));
                $precioDes = ($row['precio'] * (($row['iva'] + 100) / 100)) - ($row['precio'] * ((($row['iva'] + 100) / 100) * ($row['descuento'] / 100))) - ($row['descuentoe']);
                
                //Sacar cadena de atributos del producto.
                $atributos = "";
                $temp_at = "";
                $sql3 = "SELECT a.atributo AS valor, at.atributo AS tipo FROM bd_producto_atributo pa, bd_atributo a, bd_atributo_tipo at WHERE pa.idproducto = '".$row['id']."' AND pa.idatributo = a.id AND a.tipoid = at.id";
                    $query3 = mysqli_query($this->conexion, $sql3);
                    if (mysqli_num_rows($query3) > 0){
			while ($assoc3 = mysqli_fetch_assoc($query3)){
                            if($temp_at != $assoc3['tipo'] && $temp_at == ""){
                                $temp_at = $assoc3['tipo'];
                                $atributos .= $assoc3['tipo'].':'.$assoc3['valor'];
                            }else if($temp_at != $assoc3['tipo']){
                                $temp_at = $assoc3['tipo'];
                                $atributos .= " | ".$assoc3['tipo'].':'.$assoc3['valor'];
                            }else if($temp_at == $assoc3['tipo']){
                                $atributos .= "-".$assoc3['valor'];
                            }
                        }
                    }
                
                //Nombre producto para url.
                $nombrePurl = strtolower(str_replace(' ', '-', str_replace($this->no_permitidas, $this->permitidas , $row['nombre'])));; 
                        
                $csv.=$csv_env.$row['id'].$csv_env.
                        $csv_sep.$csv_env.$row['id'].$csv_env.
                        $csv_sep.$csv_env.$row['referencia'].$csv_env.
                        $csv_sep.$csv_env.$marca.$csv_env. 
                        $csv_sep.$csv_env.$row['nombre'].$csv_env.
                        $csv_sep.$csv_env.$precio.$csv_env.
                        $csv_sep.$csv_env.$precioDes.$csv_env.
                        $csv_sep.$csv_env.$precio.$csv_env.
                        $csv_sep.$csv_env.$row['plazoEnt'].$csv_env.
                        $csv_sep.$csv_env.$categoria.$csv_env.
                        $csv_sep.$csv_env.str_replace("\r", " ", str_replace("\n", " ", trim($row['descripcion']))).$csv_env.
                        $csv_sep.$csv_env.$atributos.$csv_env.
                        $csv_sep.$csv_env.$dominio.'/producto/'.$row['id'].'/'.$nombrePurl.$csv_env.
                        $csv_sep.$csv_env.$dominio.'/imagenesproductos/'.$row['imagenprincipal'].$csv_env;  
                
                if($tasaReembolso > -1){
                    $csv.= $csv_sep.$csv_env.number_format($tasaReembolso, 2, '.', ",").$csv_env;
                }
                if($transferencia > -1){
                    $csv.= $csv_sep.$csv_env.number_format($transferencia, 2, '.', ",").$csv_env;
                }
                if($paypal > -1){
                    $csv.= $csv_sep.$csv_env.number_format($paypal, 2, '.', ",").$csv_env;
                }
                if($domiciliacion > -1){
                    $csv.= $csv_sep.$csv_env.number_format($domiciliacion, 2, '.', ",").$csv_env;
                }
                if($entienda > -1){
                    $csv.= $csv_sep.$csv_env.number_format($entienda, 2, '.', ",").$csv_env;
                }
                if($tpv > -1){
                    $csv.= $csv_sep.$csv_env.number_format($tpv, 2, '.', ",").$csv_env;
                }
                
                $csv .= $csv_end;
            }  
            //Generamos el csv de todos los datos  
            //$file = fopen("uploads/inmuebles.xml", "w");
            if (!$handle = fopen($csv_file, "w")) {  
                echo "Cannot open file";  
                $dev = 0;
                exit;  
            }  
            if (fwrite($handle, utf8_decode($csv)) === FALSE) {  
                echo "Cannot write to file";  
                $dev = 0;
                exit;  
            }  
            fclose($handle);  
            return $dev;
        }
		
        function ActivarDescuentoPro($activacion)
	{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET actDes = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
        
        function ActivarPrecioAntPro($activacion)
	{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET actPreAnt = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
        
        function ActivarPrecioPro($activacion)
	{
			$activacion = mysqli_real_escape_string($this->conexion, htmlspecialchars($activacion));
			
			$sql = "UPDATE bd_empresa
					SET actPre = $activacion
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
	}
        
        function PresupuestoEstado($id, $estado)
		{
			$id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$estado = mysqli_real_escape_string($this->conexion, htmlspecialchars($estado));
			
			$sql = "UPDATE bd_presupuestos
					SET estado = $estado
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			return $query;
		}
            
        function SubirPrespuestoPDF($id, $nombre){
            
                        $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
			$nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
			
			$sql = "UPDATE bd_presupuestos
					SET presupuestoS = '$nombre'
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
                        			
			return $query;
            
        }
        
        function EnviarPrespuestoPDF($id){
                        $id = mysqli_real_escape_string($this->conexion, htmlspecialchars($id));
                        
                        $b = false;
                        
                        $sql = "SELECT *
					FROM bd_empresa
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$Empresa = $assoc;
			}
                        
                        $sql = "SELECT *
					FROM bd_presupuestos
					WHERE id = $id;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
                            while ($assoc = mysqli_fetch_assoc($query))
                                $Presupuesto = $assoc;
                                
                            $sql = "SELECT *
					FROM bd_users
					WHERE id = $Presupuesto[user];";
                            $query = mysqli_query($this->conexion, $sql);

                            if (mysqli_num_rows($query) == 1)
                            {
                                    while ($assoc = mysqli_fetch_assoc($query))
                                            $Usuario = $assoc;
                            
			
                        
                                $asunto = 'Presupuesto '.$Empresa['nombre'];
                                $mensaje = '<!Doctype html>
                                <html>
                                    <head>
                                        <meta charset="utf-8">
                                        <title>'.$asunto.'</title>
                                    </head>
                                    <body>
                                        <div style="width: 100%; font-family: Arial, Helvetica, sans-serif; font-size: 10px;">
                                            <h2>'.$asunto.'</h2>
                                            <p>
                                               Hola '.$Usuario[nombre].'!<br />
                                               Hemos realizado un presupuesto para su petición.<br />
                                            </p>
                                            <p>
                                                Puede ver el presupuesto pinchando<strong> <a href="'.$Empresa[dominio].'presupuestos/'.$Presupuesto[presupuestoS].'">aquí</a></strong>
                                            </p>
                                            <p>
                                                Cordiales saludos!
                                            </p>
                                            <p>
                                                Este es un mensaje enviado automáticamente, por favor, no responder<br />
                                                Las respuestas a este mensaje no serán leídas por nadie.
                                            </p>
                                        </div>
                                    </body>
                                </html>';
                                $para = $Usuario['email'];

                                $b = $this->EnviarEmail($para, $asunto, $mensaje);
                                if($b){
                                    $sql = "UPDATE bd_presupuestos
                                                SET enviado = 1, estado = 1
                                                WHERE id = $id;";
                                    $query = mysqli_query($this->conexion, $sql);
                                }
                            }
                        }			
			return $b;
                        
        }
        
        function EnviarEmail($para, $asunto, $mensaje){
                        $sql = "SELECT *
					FROM bd_empresa
					WHERE id = 1;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) == 1)
			{
				while ($assoc = mysqli_fetch_assoc($query))
					$Empresa = $assoc;
			}
                        
                        if($Empresa['envimail'] == 0){
                            require_once('../scripts/PHPMailerAutoload.php');

                            $mail = new PHPMailer;
                            $mail->isSendmail();

                            $mail->addAddress($para);
                            $mail->setFrom("$Empresa[email]", "$Empresa[nombre]");

                            $mail->Subject = $asunto;
                            $mail->IsHTML(true);
                            $mail->CharSet = "UTF-8";
                            $mail->msgHTML($mensaje);

                            if (!$mail->send())
                                    return false;
                            else
                                    return true;
                        }else{
                            require_once('../scripts/class.phpmailer.php');
                            require_once('../scripts/class.smtp.php');

                            $mail = new PHPMailer();
                            $mail->isSMTP();
                            $mail->SMTPAuth = true;
                            $mail->Timeout=30;
                            $mail->CharSet = "UTF-8";

                            if ($Empresa['segSmtp'] == 0)
                                $seg = 'tls';
                            else
                                $seg = 'ssl';

                            $mail->SMTPSecure = $seg;
                            $mail->Host = $Empresa['hostSmtp'];
                            $mail->Port = $Empresa['puertoSmtp'];
                            $mail->Username   = $Empresa['mailSmtp'];
                            $mail->Password   = $Empresa['passSmtp'];

                            $mail->SetFrom("$Empresa[email]", "$Empresa[nombre]");
                            $mail->AddReplyTo("$Empresa[email]","$Empresa[nombre]");
                            $mail->AddAddress($para);

                            $mail->Subject = "$asunto";
                            $mail->AltBody = $mensaje;
                            $mail->MsgHTML("$mensaje.");

                            $exito = $mail->send();

                            $intentos=1; 
                             while ((!$exito) && ($intentos < 2)) {
                                    $exito = $mail->send();
                                    $intentos=$intentos+1;    
                           }
                           if(!$exito)
                            {
                                return false;
                            }
                            else
                            {
                                return true;
                            }
                        }
        }
        
        function ModificarPagos($pay, $tpv, $trans, $contra, $domi, $tienda, $aplaz){
            $pay = mysqli_real_escape_string($this->conexion, htmlspecialchars($pay));
            $tpv = mysqli_real_escape_string($this->conexion, htmlspecialchars($tpv));
            $trans = mysqli_real_escape_string($this->conexion, htmlspecialchars($trans));
            $contra = mysqli_real_escape_string($this->conexion, htmlspecialchars($contra));
            $domi = mysqli_real_escape_string($this->conexion, htmlspecialchars($domi));
            $tienda = mysqli_real_escape_string($this->conexion, htmlspecialchars($tienda));
            $aplaz = mysqli_real_escape_string($this->conexion, htmlspecialchars($aplaz));
            			
            $sql = "UPDATE bd_empresa
                        SET paypalNombre = '$pay', tpvNombre = '$tpv', transfeNombre = '$trans', contraNombre = '$contra', domiNombre = '$domi', tiendaNombre = '$tienda', aplazaNombre = '$aplaz'
                        WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }
        
        function ModificarPedido($permBor, $permCant){
            $permBor = mysqli_real_escape_string($this->conexion, htmlspecialchars($permBor));
            $permCant = mysqli_real_escape_string($this->conexion, htmlspecialchars($permCant));
            
            $sql = "UPDATE bd_empresa
                        SET permBor = '$permBor', permCant = '$permCant'
                        WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }
        
        function ModificarMM($MM_anchoMax, $MM_fondo, $MM_divisiones, $MM_colores, $MM_despliegue, $Napartados){
            $MM_anchoMax = mysqli_real_escape_string($this->conexion, htmlspecialchars($MM_anchoMax));
            $MM_fondo = mysqli_real_escape_string($this->conexion, htmlspecialchars($MM_fondo));
            $MM_divisiones = mysqli_real_escape_string($this->conexion, htmlspecialchars($MM_divisiones));
            $MM_colores = mysqli_real_escape_string($this->conexion, htmlspecialchars($MM_colores));
            $MM_despliegue = mysqli_real_escape_string($this->conexion, htmlspecialchars($MM_despliegue));
            $Napartados = mysqli_real_escape_string($this->conexion, htmlspecialchars($Napartados));
            
            $sql = "UPDATE bd_configuracion
                        SET MM_anchoMax = '$MM_anchoMax', MM_fondo = '$MM_fondo', MM_divisiones = '$MM_divisiones', MM_colores = '$MM_colores', MM_despliegue = '$MM_despliegue', Napartados = '$Napartados'
                        WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }
        
        function EliminarImgFondo()
        {
            $sql = "UPDATE bd_configuracion
					SET fcabecera = ''
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
        }
        
        function EliminarLogo($logo)
        {
            $sql = "UPDATE bd_empresa
					SET $logo = ''
					WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
        }
        
        function CategoriasActualizaOrden($id, $valor)
        {
            $sql = "UPDATE bd_categorias SET orden = '$valor' WHERE id = '$id'";
            $query = mysqli_query($this->conexion, $sql);
            return $query;
        }
        
        function CambiarMMBlog($plt)
        {
            $plt = mysqli_real_escape_string($this->conexion, htmlspecialchars($plt));
            
            $sql = "UPDATE bd_configuracion
                        SET MM_blog = '$plt'
                        WHERE id = 1;";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }
        
        function SubirProductoRapido($nombre, $precio, $referencia, $categoria)
        {
            $nombre = mysqli_real_escape_string($this->conexion, htmlspecialchars($nombre));
            $precio = mysqli_real_escape_string($this->conexion, htmlspecialchars($precio));
            $referencia = mysqli_real_escape_string($this->conexion, htmlspecialchars($referencia));
            $categoria = mysqli_real_escape_string($this->conexion, htmlspecialchars($categoria));
            
            $sql = "INSERT INTO bd_productos (id, nombre, precio, referencia, idcat) VALUES (null, '$nombre', '$precio', '$referencia', '$categoria')";
            $query = mysqli_query($this->conexion, $sql);
            
            return $query;
        }

	//Cargar roles de usuarios
	function CargarRoles($limit = 1000)
		{
			$resultados = array();
			
			$sql = "SELECT * FROM bd_rol ORDER BY rol ASC LIMIT $limit;";
			$query = mysqli_query($this->conexion, $sql);
			
			if (mysqli_num_rows($query) > 0)
				while ($assoc = mysqli_fetch_assoc($query))
					$resultados[] = $assoc;

			return $resultados;
		} 
            
    }
        
        
                
?>